<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="bootstrap.css">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="navbar">
            <div class="navbar-inner">
                <div class="container">
                    <span class="brand"> Test Coverage</span>
                    <ul class="nav">
                        <li class="dropdown"> <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><a href="#lib">./lib (54%)</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="span6" style="margin-top: 10px;">
                        <div class="progress progress-warning"> <div class="bar" style="width: 54%"><strong>54%</strong> [519/961]</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="group-header row" id="lib"><div class="group-name span5">./lib</div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 54%"><strong>54%</strong> [519/961]</div></div></div></div><div id="lib-generators-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-generators-js" class="filename trigger" name="lib-generators-js">lib/generators.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 78%"><strong>78%</strong> [211/269]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> path      = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> fs        = <span class="func">require</span>(<span class="S">'fs'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> sys       = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> utils     = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Shortcut required railway utils</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> pluralize = utils.pluralize;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> camelize  = utils.camelize;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> $         = utils.stylize.$;</code><span class="hits">1</span></li><li class=""><code><span class="kwrd">var</span> exec      = <span class="func">require</span>(<span class="S">'child_process'</span>).exec</code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Command line options</span></code></li><li class=""><code><span class="C"> * populated by parseOptions method</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @api private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> options   = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Generators collection hash</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @type Hash</span></code></li><li class=""><code><span class="C"> * @api private</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code><span class="kwrd">var</span> collection = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add generator to collection</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param name</span></code></li><li class=""><code><span class="C"> * @param callback</span></code></li><li class=""><code><span class="C"> * @param meta Object {description: String, examples: [String]}</span></code></li><li class=""><code><span class="C"> * @api public</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addGenerator</span>(name, callback, meta) <span class="gly">{</span></code></li><li class="covered"><code>    meta = meta <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">5</span></li><li class="covered"><code>    callback.meta = meta;</code><span class="hits">5</span></li><li class="covered"><code>    collection<span class="gly">[</span>name<span class="gly">]</span> = callback;</code><span class="hits">5</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (meta.alias) <span class="gly">{</span></code></li><li class="covered"><code>        collection<span class="gly">[</span>meta.alias<span class="gly">]</span> = callback;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.addGenerator = addGenerator;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Check whether generator exists</span></code></li><li class=""><code><span class="C"> * @param name - name of generator</span></code></li><li class=""><code><span class="C"> * @api public</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">exists</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> !!collection<span class="gly">[</span>name<span class="gly">]</span>;</code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.exists = exists;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Call generator method</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">perform</span>(name, args) <span class="gly">{</span></code></li><li class="covered"><code>    collection<span class="gly">[</span>name<span class="gly">]</span>(args);</code><span class="hits">5</span></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.perform = perform;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.list = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> Object.<span class="func">keys</span>(collection).jo<span class="kwrd">in</span>(<span class="S">' '</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add built-in generators</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> (rw, args) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> app = rw.app;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'init'</span>, initGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'model'</span>, modelGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'controller'</span>, controllerGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'features'</span>, featuresGenerator);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">addGenerator</span>(<span class="S">'crud'</span>, crudGenerator, <span class="gly">{</span>alias: <span class="S">'scaffold'</span><span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Application initialization generator. Can be called with leading</span></code></li><li class=""><code><span class="C">     * appname param, or without it (init in current dir).</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * When destination</span></code></li><li class=""><code><span class="C">     * is not empty old files wouldn't be overwritten by this generator, it's safe</span></code></li><li class=""><code><span class="C">     * to call generator again and again to restore some non-existing files</span></code></li><li class=""><code><span class="C">     * initial state</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">initGenerator</span>(args) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">parseOptions</span>(<span class="S">'appname'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="gly">[</span> <span class="S">'app/'</span>,</code></li><li class=""><code>          <span class="S">'app/models/'</span>,</code></li><li class=""><code>          <span class="S">'app/controllers/'</span>,</code></li><li class=""><code>          <span class="S">'app/observers/'</span>,</code></li><li class=""><code>          <span class="S">'app/helpers/'</span>,</code></li><li class=""><code>          <span class="S">'app/views/'</span>,</code></li><li class=""><code>          <span class="S">'app/views/layouts/'</span>,</code></li><li class=""><code>          <span class="S">'db/'</span>,</code></li><li class=""><code>          <span class="S">'db/seeds/'</span>,</code></li><li class=""><code>          <span class="S">'db/seeds/development/'</span>,</code></li><li class=""><code>          <span class="S">'log/'</span>,</code></li><li class=""><code>          <span class="S">'public/'</span>,</code></li><li class=""><code>          <span class="S">'public/images'</span>,</code></li><li class=""><code>          <span class="S">'public/stylesheets/'</span>,</code></li><li class=""><code>          <span class="S">'public/javascripts/'</span>,</code></li><li class=""><code>          <span class="S">'node_modules/'</span>,</code></li><li class=""><code>          <span class="S">'config/'</span>,</code></li><li class=""><code>          <span class="S">'config/locales/'</span>,</code></li><li class=""><code>          <span class="S">'config/initializers/'</span>,</code></li><li class=""><code>          <span class="S">'config/environments/'</span></code></li><li class="covered"><code>        <span class="gly">]</span>.<span class="func">forEach</span>(createDir);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (options.stylus) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">createDir</span>(<span class="S">'app/assets/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>            <span class="func">createDir</span>(<span class="S">'app/assets/styles/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>            <span class="func">createFileByTemplate</span>(<span class="S">'app/assets/styles/example.styl'</span>, <span class="S">'example.styl'</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> db = options.db;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/initializers/db-tools'</span>, <span class="S">'db-tools'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/routes'</span>, <span class="S">'config/routes'</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="C">// createFileByTemplate('config/requirements.json', 'requirements.json');</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> srv = <span class="func">createFileByTemplate</span>(<span class="S">'server'</span>, <span class="S">'server'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> secret = <span class="func">require</span>(<span class="S">'crypto'</span>).<span class="func">createHash</span>(<span class="S">'sha1'</span>).<span class="func">update</span>(Math.<span class="func">random</span>().<span class="func">toString</span>()).<span class="func">digest</span>(<span class="S">'hex'</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">createFile</span>(<span class="S">'app/controllers/application_controller.coffee'</span>, <span class="S">'before \'protect from forgery\', -&gt;\n    protectFromForgery \''</span> + secret + <span class="S">'\'\n\n'</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">createFile</span>(<span class="S">'app/controllers/application_controller.js'</span>, <span class="S">'before(\'protect from forgery\', function () {\n    protectFromForgery(\''</span> + secret + <span class="S">'\');\n});\n'</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environment'</span>,              <span class="S">'config/environment'</span>, <span class="gly">[</span> replaceViewEngine, replacePrependMiddleware <span class="gly">]</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environments/test'</span>,        <span class="S">'config/environments/test'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environments/development'</span>, <span class="S">'config/environments/development'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/environments/production'</span>,  <span class="S">'config/environments/production'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'config/database.~'</span>,               <span class="S">'config/database_'</span> + db + <span class="S">'.~'</span>, replaceAppname);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'db/schema'</span>, <span class="S">'schema'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createViewByTemplate</span>(<span class="S">'app/views/layouts/application_layout'</span>, <span class="S">'application_layout'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/index.html'</span>, <span class="S">'index.html'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'.gitignore'</span>, fs.<span class="func">readFileSync</span>(path.jo<span class="kwrd">in</span>(__dirname, <span class="S">'/../templates/gitignore'</span>)));</code><span class="hits">1</span></li><li class=""><code>        </code></li><li class=""><code>        <span class="C">// bootstrap files</span></code></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/stylesheets/bootstrap-responsive.css'</span>, <span class="S">'bootstrap-responsive.css'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/stylesheets/bootstrap.css'</span>, <span class="S">'bootstrap.css'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/images/glyphicons-halflings-white.png'</span>, <span class="S">'glyphicons-halflings-white.png'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/images/glyphicons-halflings.png'</span>, <span class="S">'glyphicons-halflings.png'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/javascripts/bootstrap.js'</span>, <span class="S">'bootstrap.js'</span>);</code><span class="hits">1</span></li><li class=""><code>        </code></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/stylesheets/style.css'</span>, <span class="S">'style.css'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/javascripts/rails.js'</span>, <span class="S">'rails.js'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'public/javascripts/application.js'</span>, '<span class="C">// place your application-wide javascripts here\n');</span></code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'npmfile'</span>, <span class="S">'npmfile'</span>, replaceViewEngine);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'public/favicon.ico'</span>, <span class="S">'favicon.ico'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> engine = options.coffee ? <span class="S">'coffee'</span> : <span class="S">'node'</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="C">// this file is only needed for heroku deployments</span></code></li><li class=""><code>        <span class="C">// maybe not produce it by default</span></code></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'Procfile'</span>, <span class="S">'web: '</span> + engine + <span class="S">' server'</span> + fileExtension);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'package.json'</span>, <span class="S">'package.json'</span>, <span class="gly">[</span>replaceAppname, replaceViewEngine<span class="gly">]</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        fs.<span class="func">chmodSync</span>(srv, 0755);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        process.<span class="func">exit</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Generates model. Accepts list of params: first one is model name, then</span></code></li><li class=""><code><span class="C">     * fieldnames as name:type, by default type is string.</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * This generator accepts --coffee modifier to generate code in coffee</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * Example:</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     *     railway generate User email birthdate:Date isAdmin:Boolean</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * Affected files:</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * - db/schema.js</span></code></li><li class=""><code><span class="C">     * - app/models/ModelName.js</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">modelGenerator</span>(args) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">parseOptions</span>(<span class="S">'model'</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="kwrd">var</span> model = options.model, code = <span class="S">''</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="kwrd">if</span> (!model) <span class="gly">{</span> </code></li><li class="uncovered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Model name required'</span>).red.bold);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (model.<span class="func">match</span>(/\<span class="C">//)) {</span></code></li><li class="uncovered"><code>            model = model.<span class="func">match</span>(/\/(<span class="gly">[</span>^\/<span class="gly">]</span>+)$/)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (model.<span class="func">match</span>(/\./)) <span class="gly">{</span></code></li><li class="uncovered"><code>            model = model.<span class="func">match</span>(/\.(<span class="gly">[</span>^\.<span class="gly">]</span>+)$/)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code><span class="hits">2</span></li><li class="covered"><code>        <span class="kwrd">var</span> Model = model<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + model.<span class="func">slice</span>(1);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="kwrd">var</span> attrs = <span class="gly">[</span><span class="gly">]</span>, result = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">2</span></li><li class=""><code>        options.<span class="func">forEach</span>(<span class="kwrd">function</span> (arg) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">var</span> property = arg.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>0<span class="gly">]</span>,</code></li><li class=""><code>            plainType = arg.<span class="func">split</span>(<span class="S">':'</span>)<span class="gly">[</span>1<span class="gly">]</span>,</code></li><li class="covered"><code>            type = <span class="func">formatType</span>(plainType);</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>                attrs.<span class="func">push</span>(<span class="S">'    property \''</span> + property + <span class="S">'\', '</span> + type);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                attrs.<span class="func">push</span>(<span class="S">'    property(\''</span> + property + <span class="S">'\', '</span> + type + <span class="S">');'</span>);</code><span class="hits">4</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>            result.<span class="func">push</span>(<span class="gly">{</span>name: property, type: type, plainType: plainType<span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/'</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/models/'</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'app/models/'</span> + model + fileExtension, <span class="S">''</span>);</code><span class="hits">2</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class=""><code>            code = Model + <span class="S">' = describe \''</span> + Model + <span class="S">'\', () -&gt;\n'</span> +</code></li><li class="uncovered"><code>            attrs.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>) + <span class="S">'\n'</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            code = <span class="S">'var '</span> + Model + <span class="S">' = describe(\''</span> + Model + <span class="S">'\', function () {\n'</span> +</code></li><li class="covered"><code>            attrs.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>) + <span class="S">'\n});'</span>;</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'db/'</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'db/schema'</span> + fileExtension, <span class="S">''</span>);</code><span class="hits">2</span></li><li class="covered"><code>        utils.<span class="func">appendToFile</span>(<span class="S">'db/schema'</span> + fileExtension, code);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="kwrd">return</span> result;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Generates single controller and related views. Accepts arguments:</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     *  - controller name</span></code></li><li class=""><code><span class="C">     *  - action names</span></code></li><li class=""><code><span class="C">     *  - `--coffee` modifier can be passed to generate code in coffee</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * Affected files:</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     *  - app/controllers/controller_name_controller.js</span></code></li><li class=""><code><span class="C">     *  - app/views/controller_name/action1.ejs</span></code></li><li class=""><code><span class="C">     *  - app/views/controller_name/action2.ejs</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">controllerGenerator</span>(args) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">parseOptions</span>(<span class="S">'controller'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> controller = options.controller;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!controller) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Usage example: railway g controller controllername actionName anotherActionName'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'               railway g controller controllername actionName anotherActionName --coffee'</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> fileExtension;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> actions;</code><span class="hits">1</span></li><li class=""><code>        <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>            fileExtension = <span class="S">'.coffee'</span>;</code></li><li class="uncovered"><code>            actions = <span class="gly">[</span><span class="S">'load \'application\''</span><span class="gly">]</span>;</code></li><li class=""><code>            options.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="uncovered"><code>                actions.<span class="func">push</span>(<span class="S">'action \''</span> + action + <span class="S">'\', () -&gt; \n    render\n        title: "'</span> + controller + <span class="S">'#'</span> + action + <span class="S">'"'</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            fileExtension = <span class="S">'.js'</span>;</code><span class="hits">1</span></li><li class="covered"><code>            actions = <span class="gly">[</span><span class="S">'load(\'application\');'</span><span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code>            options.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="covered"><code>                actions.<span class="func">push</span>(<span class="S">'action(\''</span> + action + <span class="S">'\', function () {\n    render({\n        title: "'</span> + controller + <span class="S">'#'</span> + action + <span class="S">'"\n    });\n});'</span>);</code><span class="hits">6</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> ns = controller.<span class="func">split</span>(<span class="S">'/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        ns.<span class="func">pop</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/controllers/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/controllers/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// controller</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> filename = <span class="S">'app/controllers/'</span> + controller + <span class="S">'_controller'</span>  + fileExtension;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFile</span>(filename, actions.jo<span class="kwrd">in</span>(<span class="S">'\n\n'</span>));</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/helpers/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/helpers/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// helper</span></code></li><li class="covered"><code>        filename = <span class="S">'app/helpers/'</span> + controller + <span class="S">'_helper.js'</span>;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFile</span>(filename, <span class="S">'module.exports = {\n};'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// views</span></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/views/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span> + controller + <span class="S">'/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        options.<span class="func">forEach</span>(<span class="kwrd">function</span> (action) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">createView</span>(<span class="S">'app/views/'</span> + controller + <span class="S">'/'</span> + action, <span class="S">'default_action_view'</span>, <span class="gly">[</span>controller, action<span class="gly">]</span>);</code><span class="hits">6</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Cucumis features generator</span></code></li><li class=""><code><span class="C">     * @deprecated</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">featuresGenerator</span>() <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'features/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'features/step_definitions/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'features/step_definitions/web_steps.js'</span>,   <span class="S">'features/step_definitions/web_steps.js'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'features/step_definitions/email_steps.js'</span>, <span class="S">'features/step_definitions/email_steps.js'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'features/step_definitions/jquery.js'</span>,      <span class="S">'features/step_definitions/jquery.js'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">require</span>(<span class="S">'cucumis'</span>);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Cucumis is not installed'</span>).red + <span class="S">' please run '</span> + <span class="func">$</span>(<span class="S">'npm install cucumis'</span>).yellow);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Resource scaffolding generator. Accepts same arguments as model generator:</span></code></li><li class=""><code><span class="C">     * name of model (singilar) and list of model properties in</span></code></li><li class=""><code><span class="C">     * `property:type` format</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * It creates ready-to-use model, controller, controller tests (nodeunit),</span></code></li><li class=""><code><span class="C">     * routing rule, views and layout</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @api public</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">crudGenerator</span>(args) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> model = args<span class="gly">[</span>0<span class="gly">]</span>.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">pop</span>();</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> parents = args<span class="gly">[</span>0<span class="gly">]</span>.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">slice</span>(0, -1);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> models = <span class="func">pluralize</span>(model).toLower<span class="kwrd">Case</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (!model) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Usage example: railway g crud post title:string content:string published:boolean'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'               railway g crud post title:string content:string published:boolean --coffee'</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> ns = models.<span class="func">split</span>(<span class="S">'/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        ns.<span class="func">pop</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/controllers/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/controllers/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> result = modelGenerator.<span class="func">apply</span>(this, Array.<span class="kwrd">prototype</span>.slice.<span class="func">call</span>(arguments));</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'app/controllers/'</span> + models + <span class="S">'_controller'</span> + fileExtension, <span class="func">controllerCode</span>(args<span class="gly">[</span>0<span class="gly">]</span>, result));</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/helpers/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/helpers/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">replaceModel</span>(code) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> code</code><span class="hits">1</span></li><li class=""><code>                .<span class="func">replace</span>(/new_model/g, <span class="func">addParents</span>(<span class="S">'new_'</span>, parents, model))</code></li><li class=""><code>                .<span class="func">replace</span>(/edit_model/g, <span class="func">addParents</span>(<span class="S">'edit_'</span>, parents, model, true))</code></li><li class=""><code>                .<span class="func">replace</span>(/path_to\.models/g, <span class="func">addParents</span>(<span class="S">'path_to.'</span>, parents, models))</code></li><li class=""><code>                .<span class="func">replace</span>(/path_to\.model/g, <span class="func">addParents</span>(<span class="S">'path_to.'</span>, parents, model, true))</code></li><li class=""><code>                .<span class="func">replace</span>(/(path_to\..*?\()model/g, <span class="func">addParents</span>(<span class="S">'$1'</span>, parents.<span class="func">map</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span> <span class="kwrd">return</span> <span class="S">'params.'</span> + p + <span class="S">'_id'</span>;<span class="gly">}</span>), model, true, <span class="S">', '</span>))</code></li><li class=""><code>                .<span class="func">replace</span>(/models/g, models)</code></li><li class=""><code>                .<span class="func">replace</span>(/model/g, model.toLower<span class="kwrd">Case</span>())</code></li><li class=""><code>                .<span class="func">replace</span>(/Model/g, <span class="func">camelize</span>(model, true))</code></li><li class="uncovered"><code>                .<span class="func">replace</span>(/VALID_ATTRIBUTES/, result.<span class="func">map</span>(<span class="kwrd">function</span> (attr) <span class="gly">{</span> <span class="kwrd">return</span> attr.name + <span class="S">": ''"</span> <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">',\n        '</span>));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// helper</span></code></li><li class="covered"><code>        <span class="func">createFile</span>(<span class="S">'app/helpers/'</span> + models + <span class="S">'_helper.js'</span>, <span class="S">'module.exports = {\n};'</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="C">// tests</span></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'test/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'test/test_helper.js'</span>, <span class="S">'test_helper.js'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'test/controllers'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'test/controllers/'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createFileByTemplate</span>(<span class="S">'test/controllers/'</span> + models + <span class="S">'_controller_test.js'</span>, <span class="S">'crud_controller_test.js'</span>, replaceModel);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// views</span></code></li><li class=""><code>        <span class="C">// _form partial</span></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/views/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createParents</span>(ns, <span class="S">'app/views/layouts/'</span>);</code><span class="hits">1</span></li><li class=""><code>        <span class="C">// layout</span></code></li><li class="covered"><code>        <span class="func">createViewByTemplate</span>(<span class="S">'app/views/layouts/'</span> + models + <span class="S">'_layout'</span>, <span class="S">'scaffold_layout'</span>, replaceModel);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        <span class="func">createDir</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createView</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/_form'</span>, <span class="S">'scaffold_form'</span>, result, replaceModel);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="func">createView</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/show'</span>, <span class="S">'scaffold_show'</span>, result, replaceModel);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">[</span><span class="S">'new'</span>, <span class="S">'edit'</span>, <span class="S">'index'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (template) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">createViewByTemplate</span>(<span class="S">'app/views/'</span> + models + <span class="S">'/'</span> + template, <span class="S">'scaffold_'</span> + template, replaceModel);</code><span class="hits">3</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// route</span></code></li><li class=""><code>        <span class="kwrd">var</span> routesConfig = process.<span class="func">cwd</span>() + <span class="S">'/config/routes.'</span> + (options.coffee ? <span class="S">'coffee'</span> : <span class="S">'js'</span>),</code></li><li class=""><code>            routes = fs.<span class="func">readFileSync</span>(routesConfig, <span class="S">'utf8'</span>)</code></li><li class=""><code>                .<span class="func">toString</span>()</code></li><li class=""><code>                .<span class="func">replace</span>(/\s+$/g, <span class="S">''</span>)</code></li><li class=""><code>                .<span class="func">split</span>(<span class="S">'\n'</span>),</code></li><li class=""><code>            firstLine         = routes.<span class="func">shift</span>(),</code></li><li class=""><code>            firstLineRegexp   = options.coffee ? /^exports\.routes = \(map\)\-&gt;/ : /^exports\.routes = <span class="kwrd">function</span> \(map\) \<span class="gly">{</span>/,</code></li><li class=""><code>            mapRouteResources = options.coffee ? <span class="S">'  map.resources \''</span> + models + <span class="S">'\''</span> : <span class="S">'    map.resources(\''</span> + models + <span class="S">'\');'</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (firstLine.<span class="func">match</span>() &amp;&amp; !routes.<span class="func">some</span>(containRoute)) <span class="gly">{</span></code></li><li class="covered"><code>            routes.<span class="func">unshift</span>(mapRouteResources);</code><span class="hits">1</span></li><li class="covered"><code>            routes.<span class="func">unshift</span>(firstLine);</code><span class="hits">1</span></li><li class="covered"><code>            fs.<span class="func">writeFileSync</span>(routesConfig, routes.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>));</code><span class="hits">1</span></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'patch'</span>).bold.blue + <span class="S">'  '</span> + routesConfig);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">containRoute</span>(line) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> m = line.<span class="func">match</span>(/^\s*map\.<span class="func">resources</span>(\(<span class="gly">|</span>\s)<span class="S">'([^'</span><span class="gly">]</span>+)'/);</code><span class="hits">6</span></li><li class="covered"><code>            <span class="kwrd">return</span> m &amp;&amp; m<span class="gly">[</span>1<span class="gly">]</span> == models;</code><span class="hits">6</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Get controller code</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">controllerCode</span>(model, result) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> code;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> parents = model.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">slice</span>(0, -1);</code><span class="hits">1</span></li><li class="covered"><code>        model = model.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">pop</span>();</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> models = <span class="func">pluralize</span>(model).toLower<span class="kwrd">Case</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        code = fs.<span class="func">readFileSync</span>(__dirname + <span class="S">'/../templates/crud_controller'</span> + fileExtension);</code><span class="hits">1</span></li><li class=""><code>        code = code</code></li><li class=""><code>            .<span class="func">toString</span>(<span class="S">'utf8'</span>)</code></li><li class=""><code>            .<span class="func">replace</span>(/new_model/g, <span class="func">addParents</span>(<span class="S">'new_'</span>, parents, model))</code></li><li class=""><code>            .<span class="func">replace</span>(/edit_model/g, <span class="func">addParents</span>(<span class="S">'edit_'</span>, parents, model, true))</code></li><li class=""><code>            .<span class="func">replace</span>(/path_to\.models/g, <span class="func">addParents</span>(<span class="S">'path_to.'</span>, parents, models))</code></li><li class=""><code>            .<span class="func">replace</span>(/path_to\.model/g, <span class="func">addParents</span>(<span class="S">'path_to.'</span>, parents, model, true))</code></li><li class=""><code>            .<span class="func">replace</span>(/(path_to\..*?\()this\.model/g, <span class="func">addParents</span>(<span class="S">'$1'</span>, parents.<span class="func">map</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span> <span class="kwrd">return</span> <span class="S">'params.'</span> + p + <span class="S">'_id'</span>;<span class="gly">}</span>), <span class="S">'this.'</span> + model, true, <span class="S">', '</span>))</code></li><li class=""><code>            .<span class="func">replace</span>(/models/g, models)</code></li><li class=""><code>            .<span class="func">replace</span>(/model/g, model.toLower<span class="kwrd">Case</span>())</code></li><li class=""><code>            .<span class="func">replace</span>(/Model/g, <span class="func">camelize</span>(model, true))</code></li><li class=""><code>            .<span class="func">replace</span>(/FILTER_PROPERTIES/g, <span class="S">'['</span> + result.<span class="func">map</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> <span class="S">"'"</span> + p.name + <span class="S">"'"</span>;</code><span class="hits">2</span></li><li class="covered"><code>            <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">']'</span>);</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">return</span> code;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">addParents</span>(prefix, parents, base, skipParams, jo<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> name;</code><span class="hits">10</span></li><li class="covered"><code>        <span class="kwrd">if</span> (!jo<span class="kwrd">in</span>) jo<span class="kwrd">in</span> = <span class="S">'_'</span>;</code><span class="hits">10</span></li><li class=""><code>        <span class="kwrd">if</span> (parents.length) <span class="gly">{</span></code></li><li class="uncovered"><code>            name = prefix + parents.jo<span class="kwrd">in</span>(jo<span class="kwrd">in</span>) + jo<span class="kwrd">in</span> + base;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            name = prefix + base;</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (skipParams) <span class="kwrd">return</span> name;</code><span class="hits">4</span></li><li class="covered"><code>        <span class="kwrd">return</span> name + <span class="S">'('</span> + parents.<span class="func">map</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span></code><span class="hits">4</span></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="S">'params.'</span> + p + <span class="S">'_id'</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>).jo<span class="kwrd">in</span>(<span class="S">', '</span>) + <span class="S">')'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Parse command line options</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">parseOptions</span>(defaultKeyName) <span class="gly">{</span></code></li><li class="covered"><code>        options = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">4</span></li><li class="covered"><code>        options.tpl = app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>;</code><span class="hits">4</span></li><li class="covered"><code>        options.coffee = app.<span class="func">enabled</span>(<span class="S">'coffee'</span>);</code><span class="hits">4</span></li><li class="covered"><code>        options.db = <span class="S">'memory'</span>;</code><span class="hits">4</span></li><li class="covered"><code>        options.stylus = false;</code><span class="hits">4</span></li><li class="covered"><code>        <span class="kwrd">var</span> key = defaultKeyName <span class="gly">|</span><span class="gly">|</span> false;</code><span class="hits">4</span></li><li class=""><code>        args.<span class="func">forEach</span>(<span class="kwrd">function</span> (arg) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (arg.<span class="func">slice</span>(0, 2) == <span class="S">'--'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                key = arg.<span class="func">slice</span>(2);</code><span class="hits">1</span></li><li class="covered"><code>                options<span class="gly">[</span>key<span class="gly">]</span> = true;</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (arg<span class="gly">[</span>0<span class="gly">]</span> == <span class="S">'-'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                key = arg.<span class="func">slice</span>(1);</code></li><li class="uncovered"><code>                options<span class="gly">[</span>key<span class="gly">]</span> = true;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (key) <span class="gly">{</span></code></li><li class="covered"><code>                options<span class="gly">[</span>key<span class="gly">]</span> = arg;</code><span class="hits">3</span></li><li class="covered"><code>                key = false;</code><span class="hits">3</span></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                options.<span class="func">push</span>(arg);</code><span class="hits">10</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">4</span></li><li class=""><code>        <span class="kwrd">if</span> (options.nocoffee) <span class="gly">{</span></code></li><li class="uncovered"><code>            options.coffee = false;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create directory</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createDir</span>(dir) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> root = process.<span class="func">cwd</span>();</code><span class="hits">42</span></li><li class=""><code>        <span class="kwrd">if</span> (options.appname &amp;&amp; !createDir.rootCreated) <span class="gly">{</span></code></li><li class="uncovered"><code>            createDir.rootCreated = true;</code></li><li class="uncovered"><code>            <span class="func">createDir</span>(<span class="S">''</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (options.appname) <span class="gly">{</span></code></li><li class="uncovered"><code>            dir = path.jo<span class="kwrd">in</span>(options.appname, dir);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(path.jo<span class="kwrd">in</span>(root, dir))) <span class="gly">{</span></code></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'exists'</span>).bold.grey + <span class="S">'  '</span> + dir);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            fs.<span class="func">mkdirSync</span>(path.jo<span class="kwrd">in</span>(root, dir), 0755);</code><span class="hits">40</span></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'create'</span>).bold.green + <span class="S">'  '</span> + dir);</code><span class="hits">40</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Append `contents` to a file</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} contents</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">appendToFile</span>(filename, contents) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> root = process.<span class="func">cwd</span>(),</code></li><li class="uncovered"><code>            fd = fs.<span class="func">openSync</span>(path.jo<span class="kwrd">in</span>(root, filename), <span class="S">'a'</span>);</code></li><li class="uncovered"><code>        fs.<span class="func">writeSync</span>(fd, contents);</code></li><li class="uncovered"><code>        fs.<span class="func">closeSync</span>(fd);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    utils.appendToFile = appendToFile;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create file with given `contents`</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} contents</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createFile</span>(filename, contents) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> root = process.<span class="func">cwd</span>();</code><span class="hits">38</span></li><li class=""><code>        <span class="kwrd">if</span> (options.appname) <span class="gly">{</span></code></li><li class="uncovered"><code>            filename = path.jo<span class="kwrd">in</span>(options.appname, filename);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> fullPath = root + <span class="S">'/'</span> + filename;</code><span class="hits">38</span></li><li class=""><code>        <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(fullPath)) <span class="gly">{</span></code></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'exists'</span>).bold.grey + <span class="S">'  '</span> + filename);</code><span class="hits">2</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            fs.<span class="func">writeFileSync</span>(fullPath, contents);</code><span class="hits">36</span></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'create'</span>).bold.green + <span class="S">'  '</span> + filename);</code><span class="hits">36</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> fullPath;</code><span class="hits">38</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create file with name `filename` using contents of `template` file.</span></code></li><li class=""><code><span class="C">     * Run `prepare` function before returning result</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} template</span></code></li><li class=""><code><span class="C">     * @param {Function} prepare - called with (text: {String}),</span></code></li><li class=""><code><span class="C">     * should return {String}</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createFileByTemplate</span>(filename, template, prepare) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> configFilenameRegexp = /\.~$/;</code><span class="hits">26</span></li><li class=""><code>        <span class="kwrd">if</span> (template.<span class="func">match</span>(configFilenameRegexp)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.yml'</span> : <span class="S">'.json'</span>;</code><span class="hits">1</span></li><li class="covered"><code>            template = template.<span class="func">replace</span>(configFilenameRegexp, fileExtension);</code><span class="hits">1</span></li><li class="covered"><code>            filename = filename.<span class="func">replace</span>(configFilenameRegexp, fileExtension);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        else <span class="kwrd">if</span> (!template.<span class="func">match</span>(/\..+$/)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> fileExtension = options.coffee ? <span class="S">'.coffee'</span> : <span class="S">'.js'</span>;</code><span class="hits">9</span></li><li class="covered"><code>            template += fileExtension;</code><span class="hits">9</span></li><li class="covered"><code>            filename += fileExtension;</code><span class="hits">9</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> text = fs.<span class="func">readFileSync</span>(path.jo<span class="kwrd">in</span>(__dirname, <span class="S">'/../templates/'</span>, template));</code><span class="hits">26</span></li><li class=""><code>        <span class="kwrd">if</span> (prepare) <span class="gly">{</span></code></li><li class="covered"><code>            text = text.<span class="func">toString</span>(<span class="S">'utf8'</span>);</code><span class="hits">5</span></li><li class=""><code>            <span class="kwrd">if</span> (<span class="kwrd">typeof</span> prepare === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>                prepare = <span class="gly">[</span>prepare<span class="gly">]</span>;</code><span class="hits">3</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            prepare.<span class="func">forEach</span>(<span class="kwrd">function</span> (p) <span class="gly">{</span></code></li><li class="covered"><code>                text = <span class="func">p</span>(text);</code><span class="hits">7</span></li><li class="covered"><code>            <span class="gly">}</span>);</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> <span class="func">createFile</span>(filename, text);</code><span class="hits">26</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Create view file with name `filename` using contents of `template` file.</span></code></li><li class=""><code><span class="C">     * Run `prepare` function before returning result. It look for -tpl option</span></code></li><li class=""><code><span class="C">     * and result file with proper extension and contents</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @param {String} filename</span></code></li><li class=""><code><span class="C">     * @param {String} template</span></code></li><li class=""><code><span class="C">     * @param {Function} prepare - called with (text: {String}),</span></code></li><li class=""><code><span class="C">     * should return {String}</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @private</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createViewByTemplate</span>(filename, template, prepare) <span class="gly">{</span></code></li><li class="covered"><code>        options.tpl = options.tpl <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>;</code><span class="hits">5</span></li><li class="covered"><code>        <span class="kwrd">var</span> package = options.tpl + <span class="S">'-ext'</span>, tpl;</code><span class="hits">5</span></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            tpl = <span class="func">require</span>(package);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Templating engine '</span> + options.tpl + <span class="S">' is not supported'</span>).red);</code><span class="hits">5</span></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">5</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> text = fs.<span class="func">readFileSync</span>(tpl.<span class="func">template</span>(template));</code></li><li class=""><code>        <span class="kwrd">if</span> (prepare) <span class="gly">{</span></code></li><li class="uncovered"><code>            text = <span class="func">prepare</span>(text.<span class="func">toString</span>(<span class="S">'utf8'</span>));</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">createFile</span>(filename + tpl.extension, text);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createView</span>(filename, template, data, fn) <span class="gly">{</span></code></li><li class="covered"><code>        options.tpl = options.tpl <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>;</code><span class="hits">8</span></li><li class="covered"><code>        <span class="kwrd">var</span> package = options.tpl + <span class="S">'-ext'</span>;</code><span class="hits">8</span></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> tpl = <span class="func">require</span>(package);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="covered"><code>            sys.<span class="func">puts</span>(<span class="func">$</span>(<span class="S">'Templating engine '</span> + options.tpl + <span class="S">' is not supported'</span>).red);</code><span class="hits">8</span></li><li class="covered"><code>            <span class="kwrd">return</span>;</code><span class="hits">8</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> text = tpl.<span class="func">templateText</span>(template, data);</code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> fn === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            text = <span class="func">fn</span>(text.<span class="func">toString</span>());</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">createFile</span>(filename + tpl.extension, text);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">createParents</span>(ns, d) <span class="gly">{</span></code></li><li class=""><code>        ns.<span class="func">forEach</span>(<span class="kwrd">function</span> (dir) <span class="gly">{</span></code></li><li class="uncovered"><code>            d = path.jo<span class="kwrd">in</span>(d, dir);</code></li><li class="uncovered"><code>            <span class="func">createDir</span>(d);</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">formatType</span>(name) <span class="gly">{</span></code></li><li class="covered"><code>        name = (name <span class="gly">|</span><span class="gly">|</span> <span class="S">'string'</span>).toLower<span class="kwrd">Case</span>();</code><span class="hits">4</span></li><li class=""><code>        <span class="kwrd">switch</span> (name) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'text'</span>: <span class="kwrd">return</span> <span class="S">'Text'</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'string'</span>:   <span class="kwrd">return</span> <span class="S">'String'</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'date'</span>:     <span class="kwrd">return</span> <span class="S">'Date'</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'bool'</span>:</code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'boolean'</span>:  <span class="kwrd">return</span> <span class="S">'Boolean'</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'int'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'real'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'float'</span>:</code></li><li class=""><code>        <span class="kwrd">case</span> <span class="S">'decimal'</span>:</code></li><li class="uncovered"><code>        <span class="kwrd">case</span> <span class="S">'number'</span>:   <span class="kwrd">return</span> <span class="S">'Number'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="S">'"'</span> + <span class="func">camelize</span>(name, true) + <span class="S">'"'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">replaceAppname</span>(template) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> template.<span class="func">replace</span>(/APPNAME/g, options.appname <span class="gly">|</span><span class="gly">|</span> <span class="S">'default'</span>);</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">replaceViewEngine</span>(template) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> template.<span class="func">replace</span>(/VIEWENGINE/g, options.tpl <span class="gly">|</span><span class="gly">|</span> <span class="S">'ejs'</span>);</code><span class="hits">3</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">replacePrependMiddleware</span>(template) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> mw = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="kwrd">if</span> (options.stylus) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (options.coffee) <span class="gly">{</span></code></li><li class="uncovered"><code>                mw.<span class="func">push</span>(<span class="S">"app.use require('stylus').middleware\n        force: true, src: app.root + '/app/assets', dest: app.root + '/public', compress: true"</span>.<span class="func">replace</span>(/, /g, <span class="S">',\n        '</span>));</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                mw.<span class="func">push</span>(<span class="S">"app.use(require('stylus').middleware({\n        force: true, src: app.root + '/app/assets', dest: app.root + '/public', compress: true\n    }));"</span>.<span class="func">replace</span>(/, /g, <span class="S">',\n        '</span>));</code><span class="hits">1</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> template.<span class="func">replace</span>(/PREPEND_MIDDLEWARE/g, mw.jo<span class="kwrd">in</span>(<span class="S">'\n    '</span>));</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">loadConfig</span>(filename) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> filenameExt = /\.(<span class="gly">[</span>^\.<span class="gly">]</span>+)$/.<span class="func">exec</span>(filename)<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">switch</span> (filenameExt) <span class="gly">{</span></code></li><li class=""><code>          <span class="kwrd">case</span> <span class="S">'~'</span>:</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> config = null;</code></li><li class=""><code>            <span class="gly">[</span><span class="S">'.json'</span>,<span class="S">'.yml'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span>(testExt)<span class="gly">{</span></code></li><li class=""><code>              try <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">var</span> testFilename = filename.<span class="func">replace</span>(/\.~$/, testExt)</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> stats = fs.<span class="func">lstatSync</span>(testFilename);</code></li><li class=""><code>                <span class="kwrd">if</span> (stats.<span class="func">isFile</span>())</code></li><li class="uncovered"><code>                  config = <span class="func">loadConfig</span>(testFilename);</code></li><li class=""><code>              <span class="gly">}</span></code></li><li class=""><code>              <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (config != null) <span class="kwrd">return</span> config;</code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>( sys.<span class="func">format</span>(<span class="S">'Can not find configuration file by path template "%s"'</span>, filename) );</code></li><li class="uncovered"><code>            <span class="kwrd">break</span>;</code></li><li class=""><code>          <span class="kwrd">case</span> <span class="S">'json'</span>:</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> JSON.<span class="func">parse</span>(fs.<span class="func">readFileSync</span>(filename, <span class="S">'utf8'</span>));</code></li><li class=""><code>          <span class="kwrd">case</span> <span class="S">'yml'</span>:</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">require</span>(filename).<span class="func">shift</span>();</code></li><li class=""><code>          default:</code></li><li class="uncovered"><code>            throw <span class="kwrd">new</span> <span class="func">Error</span>( sys.<span class="func">format</span>(<span class="S">'Unknown configuration file name extension "%s"'</span>, filenameExt) );</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-helpers-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-helpers-js" class="filename trigger" name="lib-helpers-js">lib/helpers.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 46%"><strong>46%</strong> [83/182]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Module dependencies</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">var</span> path       = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    fs         = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    crypto     = <span class="func">require</span>(<span class="S">'crypto'</span>),</code></li><li class="covered"><code>    exists     = fs.exists <span class="gly">|</span><span class="gly">|</span> path.exists;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Import utilities</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">var</span> htmlTagParams = <span class="func">require</span>(<span class="S">'./railway_utils'</span>).html_tag_params,</code></li><li class=""><code>    safe_merge = <span class="func">require</span>(<span class="S">'./railway_utils'</span>).safe_merge,</code></li><li class=""><code>    humanize   = <span class="func">require</span>(<span class="S">'./railway_utils'</span>).humanize,</code></li><li class="covered"><code>    undef;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Config</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">var</span> regexps = <span class="gly">{</span></code></li><li class=""><code>  <span class="S">'cached'</span>: /^cache\<span class="C">//,</span></code></li><li class=""><code>  <span class="S">'isHttp'</span>: /^https?:\/\/<span class="gly">|</span>\/\<span class="C">//</span></code></li><li class=""><code><span class="gly">}</span>,</code></li><li class=""><code>exts = <span class="gly">{</span></code></li><li class=""><code>  <span class="S">'css'</span>: <span class="S">'.css'</span>,</code></li><li class=""><code>  <span class="S">'js'</span> : <span class="S">'.js'</span></code></li><li class=""><code><span class="gly">}</span>,</code></li><li class=""><code>paths = <span class="gly">{</span></code></li><li class=""><code>  <span class="S">'css'</span>: <span class="S">'/stylesheets/'</span>,</code></li><li class=""><code>  <span class="S">'js'</span> : <span class="S">'/javascripts/'</span></code></li><li class=""><code><span class="gly">}</span>,</code></li><li class=""><code>merged = <span class="gly">{</span></code></li><li class=""><code>    stylesheets: <span class="gly">{</span>ext: exts.css<span class="gly">}</span>,</code></li><li class=""><code>    javascripts: <span class="gly">{</span>ext: exts.js<span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Publish HelperSet</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class="covered"><code>module.exports = <span class="kwrd">new</span> <span class="func">HelperSet</span>(null);</code><span class="hits">1</span></li><li class="covered"><code>module.exports.HelperSet = HelperSet;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Set of helper methods</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * @namespace</span></code></li><li class=""><code><span class="C"> * @param {Object} ctl Controller object</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">HelperSet</span>(ctl) <span class="gly">{</span></code></li><li class="covered"><code>    this.controller = ctl;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (ctl) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.controllerName = ctl.controllerName;</code></li><li class="uncovered"><code>        this.actionName = ctl.actionName;</code></li><li class="uncovered"><code>        this.pathTo = this.path_to = ctl.railway.routeMapper.pathTo;</code></li><li class="uncovered"><code>        this.t = ctl.t;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * CSRF Meta Tag generation</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @returns {String} Meta tags against CSRF-attacks</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    this.csrfMetaTag = this.csrf_meta_tag = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">return</span> ctl &amp;&amp; ctl.<span class="func">protectedFromForgery</span>() ? <span class="gly">[</span></code></li><li class=""><code>            <span class="S">'&lt;meta name="csrf-param" content="'</span> + ctl.req.csrfParam + <span class="S">'"/&gt;'</span>,</code></li><li class=""><code>            <span class="S">'&lt;meta name="csrf-token" content="'</span> + ctl.req.csrfToken + <span class="S">'"/&gt;'</span></code></li><li class="uncovered"><code>        <span class="gly">]</span>.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>) : <span class="S">''</span>;</code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Make helpers local to query</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} controller Controller Object</span></code></li><li class=""><code><span class="C"> * @returns {Object} containing all helpers</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>module.exports.personalize = <span class="kwrd">function</span> (controller) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="kwrd">new</span> module.exports.<span class="func">HelperSet</span>(controller);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Return bunch of stylesheets link tags</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example in ejs:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *      &lt;%- stylesheet_link_tag('bootstrap', 'style') %&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This returns:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *      &lt;link media="screen" rel="stylesheet" type="text/css" href="/stylesheets/bootstrap.css" /&gt;</span></code></li><li class=""><code><span class="C"> *      &lt;link media="screen" rel="stylesheet" type="text/css" href="/stylesheets/style.css" /&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} stylesheet filename</span></code></li><li class=""><code><span class="C"> * @returns {String} HTML code to the stylesheets in the parameters</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.stylesheetLinkTag = <span class="kwrd">function</span> <span class="func">stylesheetLinkTag</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> app = this.controller.app;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (!paths.css <span class="gly">|</span><span class="gly">|</span> !paths.stylesheets) <span class="gly">{</span></code></li><li class="covered"><code>      paths.css = this.controller.app.settings.cssDirectory <span class="gly">|</span><span class="gly">|</span> <span class="S">'/stylesheets/'</span>;</code><span class="hits">1</span></li><li class="covered"><code>      paths.stylesheets = paths.css;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>  </code></li><li class="covered"><code>    <span class="kwrd">var</span> args = Array.<span class="kwrd">prototype</span>.slice.<span class="func">call</span>(arguments);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> options = <span class="gly">{</span>media: <span class="S">'screen'</span>, rel: <span class="S">'stylesheet'</span>, type: <span class="S">'text/css'</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> links = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> == <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        options = <span class="func">safe_merge</span>(options, args.<span class="func">pop</span>());</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="func">mergeFiles</span>(app, <span class="S">'stylesheets'</span>, args).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="covered"><code>        delete options.href;</code><span class="hits">5</span></li><li class=""><code>        <span class="C">// there should be an option to change the /stylesheets/ folder</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> href = <span class="func">checkFile</span>(app, <span class="S">'css'</span>, file);</code><span class="hits">5</span></li><li class="covered"><code>        links.<span class="func">push</span>(<span class="func">genericTagSelfclosing</span>(<span class="S">'link'</span>, options, <span class="gly">{</span> href: href <span class="gly">}</span>));</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> links.jo<span class="kwrd">in</span>(<span class="S">'\n    '</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.<span class="kwrd">prototype</span>.stylesheet_link_tag = HelperSet.<span class="kwrd">prototype</span>.stylesheetLinkTag;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Generates set of javascript includes composed from arguments</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example in ejs:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     &lt;%- javascript_include_tag('rails', 'application') %&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This returns:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     &lt;script type="text/javascript" src="/javascripts/rails.js"&gt;&lt;/script&gt;</span></code></li><li class=""><code><span class="C"> *     &lt;script type="text/javascript" src="/javascripts/application.js"&gt;&lt;/script&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} script filename</span></code></li><li class=""><code><span class="C"> * @returns {String} the generated &amp;lt;script&amp;gt; tags</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.javascriptIncludeTag = <span class="kwrd">function</span> <span class="func">javascriptIncludeTag</span>() <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> app = this.controller.app;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (!paths.js <span class="gly">|</span><span class="gly">|</span> !paths.javascripts) <span class="gly">{</span></code></li><li class=""><code>      paths.js = this.controller.app.settings.jsDirectory <span class="gly">|</span><span class="gly">|</span> <span class="S">'/javascripts/'</span></code></li><li class="covered"><code>      paths.javascripts = paths.js;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> args = Array.<span class="kwrd">prototype</span>.slice.<span class="func">call</span>(arguments);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> options = <span class="gly">{</span>type: <span class="S">'text/javascript'</span><span class="gly">}</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> args<span class="gly">[</span>args.length - 1<span class="gly">]</span> == <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        options = <span class="func">safe_merge</span>(options, args.<span class="func">pop</span>());</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> scripts = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="func">mergeFiles</span>(app, <span class="S">'javascripts'</span>, args).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// there should be an option to change the /javascripts/ folder</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> href = <span class="func">checkFile</span>(app, <span class="S">'js'</span>, file);</code><span class="hits">5</span></li><li class="covered"><code>        delete options.src;</code><span class="hits">5</span></li><li class="covered"><code>        scripts.<span class="func">push</span>(<span class="func">genericTag</span>(<span class="S">'script'</span>, <span class="S">''</span>, options, <span class="gly">{</span>src: href<span class="gly">}</span>));</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> scripts.jo<span class="kwrd">in</span>(<span class="S">'\n    '</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.<span class="kwrd">prototype</span>.javascript_include_tag = HelperSet.<span class="kwrd">prototype</span>.javascriptIncludeTag;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Merge files when caching enabled</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * You can enable merging manually with the following configuration:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     app.set('merge javascripts')</span></code></li><li class=""><code><span class="C"> *     app.set('merge stylesheets')</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} scope Scope which is merged, e.g. javascripts or stylesheets</span></code></li><li class=""><code><span class="C"> * @param {Array} files Array of files which should be merged</span></code></li><li class=""><code><span class="C"> * @see https:~~~C4~~~</span></code></li><li class=""><code><span class="C"> * @returns {String} Pathname to the merged file</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">mergeFiles</span>(app, scope, files) <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// ensure that feature is enabled</span></code></li><li class=""><code>    <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'merge '</span> + scope)) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> files;</code><span class="hits">8</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">var</span> ext  = merged<span class="gly">[</span>scope<span class="gly">]</span>.ext,</code></li><li class=""><code>      result = <span class="gly">[</span><span class="gly">]</span>,</code></li><li class=""><code>      shasum = crypto.<span class="func">createHash</span>(<span class="S">'sha1'</span>),</code></li><li class=""><code>      minify = <span class="gly">[</span><span class="gly">]</span>,</code></li><li class="uncovered"><code>      directory = merged<span class="gly">[</span>scope<span class="gly">]</span>.directory = paths<span class="gly">[</span>scope<span class="gly">]</span>.<span class="func">replace</span>(/(\/+)/g, <span class="S">''</span>);</code></li><li class=""><code>    <span class="C">// only merge local files</span></code></li><li class=""><code>    files.<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!regexps.isHttp.<span class="func">test</span>(file)) <span class="gly">{</span></code></li><li class="uncovered"><code>            shasum.<span class="func">update</span>(file);</code></li><li class="uncovered"><code>            minify.<span class="func">push</span>(file);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            result.<span class="func">push</span>(file);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// calculate name of new script based on names of merged files</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> digest = shasum.<span class="func">digest</span>(<span class="S">'hex'</span>);</code></li><li class=""><code>    <span class="C">// check cache state (undefined = not cached, false = cache in progress, String = cached)</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> cached = merged<span class="gly">[</span>scope<span class="gly">]</span><span class="gly">[</span>digest<span class="gly">]</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (cached) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// push resulted filename to result</span></code></li><li class="uncovered"><code>        result.<span class="func">push</span>(cached);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// we have no cache at the moment, just return files</span></code></li><li class="uncovered"><code>        result = result.<span class="func">concat</span>(minify);</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">// if caching process is not started yet</span></code></li><li class=""><code>        <span class="kwrd">if</span> (cached !== false) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// mark caching process as started</span></code></li><li class="uncovered"><code>            merged<span class="gly">[</span>scope<span class="gly">]</span><span class="gly">[</span>digest<span class="gly">]</span> = false;</code></li><li class=""><code>            <span class="C">// write resulted script as merged `minify` files</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> stream = fs.<span class="func">createWriteStream</span>(path.jo<span class="kwrd">in</span>(app.root, <span class="S">'public'</span>, directory, <span class="S">'cache_'</span> + digest + ext));</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> counter = 0;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> fileContents = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            minify.<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> filename = path.jo<span class="kwrd">in</span>(app.root, <span class="S">'public'</span>, directory, file + ext);</code></li><li class=""><code>                <span class="func">exists</span>(filename, <span class="kwrd">function</span> (exists) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (exists) <span class="gly">{</span></code></li><li class="uncovered"><code>                        counter += 1;</code></li><li class=""><code>                        </code></li><li class=""><code>                        fs.<span class="func">readFile</span>(filename, <span class="S">'utf8'</span>, <span class="kwrd">function</span> (err, data) <span class="gly">{</span></code></li><li class="uncovered"><code>                            fileContents<span class="gly">[</span>file<span class="gly">]</span> = data;</code></li><li class="uncovered"><code>                            <span class="func">done</span>();</code></li><li class="uncovered"><code>                        <span class="gly">}</span>);</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                <span class="gly">}</span>)</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>            <span class="kwrd">function</span> <span class="func">done</span>() <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (--counter === 0) <span class="gly">{</span></code></li><li class=""><code>                    minify.<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>                      data = fileContents<span class="gly">[</span>file<span class="gly">]</span>;</code></li><li class="uncovered"><code>                      stream.<span class="func">write</span>(<span class="S">'~~~C52~~~ \n'</span>);</code></li><li class="uncovered"><code>                      stream.<span class="func">write</span>(data + <span class="S">'\n'</span>);</code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code>                    </code></li><li class="uncovered"><code>                    stream.<span class="func">end</span>();</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="C">// save name of resulted file to the merge scope registry</span></code></li><li class=""><code>            stream.<span class="func">on</span>(<span class="S">'close'</span>, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>                merged<span class="gly">[</span>scope<span class="gly">]</span><span class="gly">[</span>digest<span class="gly">]</span> = <span class="gly">[</span><span class="S">'cache'</span>, digest<span class="gly">]</span>.jo<span class="kwrd">in</span>(<span class="S">'_'</span>);</code></li><li class=""><code>            <span class="gly">}</span>)</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> result;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Link helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example in ejs:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *      &lt;%- link_to("Home", '/') %&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * This returns:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *      &lt;a href="/"&gt;Home&lt;/a&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} text Text of the link</span></code></li><li class=""><code><span class="C"> * @param {String} url Url where the link points to</span></code></li><li class=""><code><span class="C"> * @param {Object} params Set of html params (class, style, etc..)</span></code></li><li class=""><code><span class="C"> * @returns {String} Generated html for link</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.linkTo = <span class="kwrd">function</span> <span class="func">linkTo</span>(text, url, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="gly">[</span><span class="S">'remote'</span>, <span class="S">'method'</span>, <span class="S">'jsonp'</span>, <span class="S">'confirm'</span><span class="gly">]</span>.<span class="func">forEach</span>(dataParam.<span class="func">bind</span>(params));</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'a'</span>, text, <span class="gly">{</span>href: url<span class="gly">}</span>, params);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.<span class="kwrd">prototype</span>.link_to = HelperSet.<span class="kwrd">prototype</span>.linkTo;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Form tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} block</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.formTag = <span class="kwrd">function</span> (params, block) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> buf = arguments.callee.caller.buf;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">if</span> (!buf) buf = arguments.callee.caller.caller.buf;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">if</span> (!buf) buf = arguments.callee.caller.caller.caller.buf;</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// helper may be called with block only</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        block = params;</code><span class="hits">1</span></li><li class="covered"><code>        params = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class=""><code>        params = <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// default method is POST</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!params.method) <span class="gly">{</span></code></li><li class="covered"><code>        params.method = <span class="S">'POST'</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// hook up alternative methods (PUT, DELETE)</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> _method;</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">var</span> method = _method = params.method.toUpper<span class="kwrd">Case</span>();</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (method != <span class="S">'GET'</span> &amp;&amp; method != <span class="S">'POST'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        _method = method;</code><span class="hits">2</span></li><li class="covered"><code>        params.method = <span class="S">'POST'</span>;</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// hook up data-params</span></code></li><li class="covered"><code>    <span class="gly">[</span><span class="S">'remote'</span>, <span class="S">'jsonp'</span>, <span class="S">'confirm'</span><span class="gly">]</span>.<span class="func">forEach</span>(dataParam.<span class="func">bind</span>(params));</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// push output</span></code></li><li class="covered"><code>    buf.<span class="func">push</span>(<span class="S">'&lt;form'</span> + <span class="func">htmlTagParams</span>(params) + <span class="S">'&gt;'</span>);</code><span class="hits">4</span></li><li class="covered"><code>    buf.<span class="func">push</span>( this.<span class="func">csrf_tag</span>() );</code><span class="hits">4</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// alternative method?</span></code></li><li class=""><code>    <span class="kwrd">if</span> (_method !== params.method) <span class="gly">{</span></code></li><li class="covered"><code>        buf.<span class="func">push</span>(HelperSet.<span class="kwrd">prototype</span>.<span class="func">input_tag</span>(<span class="gly">{</span>type: <span class="S">"hidden"</span>, name: <span class="S">"_method"</span>, value: _method <span class="gly">}</span>));</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    </code></li><li class=""><code>    <span class="C">// function?</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> block === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="func">block</span>();</code><span class="hits">2</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    buf.<span class="func">push</span>(<span class="S">'&lt;/form&gt;'</span>);</code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.<span class="kwrd">prototype</span>.form_tag = HelperSet.<span class="kwrd">prototype</span>.formTag;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Prints error messages for the model instance</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @param {ModelInstance} resource</span></code></li><li class=""><code><span class="C"> * @returns {String} Error messages from the model instance</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.errorMessages<span class="kwrd">For</span> = <span class="kwrd">function</span> errorMessages<span class="kwrd">For</span>(resource) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> out = <span class="S">''</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> h = this;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (resource.errors) <span class="gly">{</span></code></li><li class="uncovered"><code>        out += <span class="func">genericTag</span>(<span class="S">'div'</span>, <span class="func">printErrors</span>(), <span class="gly">{</span>class: <span class="S">'alert alert-error'</span><span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> out;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">printErrors</span>() <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> out = <span class="S">'&lt;p&gt;'</span>;</code></li><li class="uncovered"><code>        out += <span class="func">genericTag</span>(<span class="S">'strong'</span>, <span class="S">'Validation failed. Fix following errors before you continue:'</span>);</code></li><li class="uncovered"><code>        out += <span class="S">'&lt;/p&gt;'</span>;</code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> prop <span class="kwrd">in</span> resource.errors) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (resource.errors.<span class="func">hasOwnProperty</span>(prop)) <span class="gly">{</span></code></li><li class="uncovered"><code>                out += <span class="S">'&lt;ul&gt;'</span>;</code></li><li class=""><code>                resource.errors<span class="gly">[</span>prop<span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (msg) <span class="gly">{</span></code></li><li class="uncovered"><code>                    out += <span class="func">genericTag</span>(<span class="S">'li'</span>, prop + <span class="S">' '</span> + msg, <span class="gly">{</span>class: <span class="S">'error-message'</span><span class="gly">}</span>);</code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>                out += <span class="S">'&lt;/ul&gt;'</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> out;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Form fields for resource helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @param {ModelInstance} resource</span></code></li><li class=""><code><span class="C"> * @param {Function} block</span></code></li><li class=""><code><span class="C"> * @namespace</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.fields<span class="kwrd">For</span> = <span class="kwrd">function</span> (resource, block) <span class="gly">{</span></code></li><li class="uncovered"><code>    arguments.callee.buf = arguments.callee.caller.buf;</code></li><li class="uncovered"><code>    resource = resource <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> resourceName = resource &amp;&amp; resource.constructor &amp;&amp; resource.constructor.modelName <span class="gly">|</span><span class="gly">|</span> false;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> complexNames = (this.controller.app.<span class="func">set</span>(<span class="S">'view options'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>).complexNames;</code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Generates a name</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @requires resourceName</span></code></li><li class=""><code><span class="C">     * @param {String} name Name of the element</span></code></li><li class=""><code><span class="C">     * @returns {String} returns the generated name</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">makeName</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> complexNames &amp;&amp; resourceName ? (resourceName + <span class="S">'['</span> + name + <span class="S">']'</span>) : name;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Generates an id field</span></code></li><li class=""><code><span class="C">     *</span></code></li><li class=""><code><span class="C">     * @requires resourceName</span></code></li><li class=""><code><span class="C">     * @param {String} name Name of the element</span></code></li><li class=""><code><span class="C">     * @returns {String} returns the generated id name</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">makeId</span>(name) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> complexNames &amp;&amp; resourceName ? (resourceName + <span class="S">'_'</span> + name) : name;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="func">block</span>(<span class="gly">{</span></code></li><li class=""><code>        <span class="C">/**</span></code></li><li class=""><code><span class="C">         * Input tag helper</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * Example in ejs:</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         *      &lt;%- form.input("test") %&gt;</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * This returns:</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         *      &lt;input name="test"/&gt;</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * @param {String} name Name of the element</span></code></li><li class=""><code><span class="C">         * @param {Object} params Additional parameters</span></code></li><li class=""><code><span class="C">         */</span></code></li><li class=""><code>        input: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="kwrd">if</span> (params.value === undef) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.value = <span class="kwrd">typeof</span> resource<span class="gly">[</span>name<span class="gly">]</span> !== <span class="S">'undefined'</span> ? resource<span class="gly">[</span>name<span class="gly">]</span> : <span class="S">''</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.<span class="kwrd">prototype</span>.<span class="func">input_tag</span>(<span class="gly">{</span></code></li><li class=""><code>                name: <span class="func">makeName</span>(name),</code></li><li class=""><code>                id: <span class="func">makeId</span>(name)</code></li><li class="uncovered"><code>            <span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        checkbox: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            <span class="kwrd">if</span> (params.value === undef) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.value = resource<span class="gly">[</span>name<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> 1;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.checked === undef) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span>(resource<span class="gly">[</span>name<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    params.checked = <span class="S">'checked'</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (params.checked === false) <span class="gly">{</span></code></li><li class="uncovered"><code>                delete params.checked;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.<span class="kwrd">prototype</span>.<span class="func">input_tag</span>(<span class="gly">{</span></code></li><li class=""><code>                name: <span class="func">makeName</span>(name),</code></li><li class=""><code>                id: <span class="func">makeId</span>(name),</code></li><li class=""><code>                type: <span class="S">'checkbox'</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        file: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.<span class="kwrd">prototype</span>.<span class="func">input_tag</span>(<span class="gly">{</span></code></li><li class=""><code>                name: <span class="func">makeName</span>(name),</code></li><li class=""><code>                id: <span class="func">makeId</span>(name),</code></li><li class=""><code>                type: <span class="S">'file'</span></code></li><li class="uncovered"><code>            <span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        <span class="C">/*</span></code></li><li class=""><code><span class="C">         * Label helper</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * Example in ejs:</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         *      &lt;%- form.label("test", false, {class: "control-label"}) %&gt;</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * This returns:</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         *      &lt;label for="test" class="control-label"&gt;Test&lt;/label&gt;</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * @param {String} name Name of the element</span></code></li><li class=""><code><span class="C">         * @param {String} caption Optional different caption of the elemt</span></code></li><li class=""><code><span class="C">         * @param {Object} params Additional parameters</span></code></li><li class=""><code><span class="C">         */</span></code></li><li class=""><code>        label: <span class="kwrd">function</span> (name, caption, params) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">return</span> HelperSet.<span class="kwrd">prototype</span>.<span class="func">label_tag</span>(</code></li><li class=""><code>                caption <span class="gly">|</span><span class="gly">|</span> self.controller.<span class="func">t</span>(<span class="S">'models.'</span> + resource.constructor.modelName + <span class="S">'.fields.'</span> + name, <span class="func">humanize</span>(name)),</code></li><li class=""><code>                <span class="gly">{</span><span class="kwrd">for</span>: <span class="func">makeId</span>(name) <span class="gly">}</span>,</code></li><li class="uncovered"><code>                params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        submit: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'button'</span>, name <span class="gly">|</span><span class="gly">|</span> <span class="S">'Commit'</span>, <span class="gly">{</span>type: <span class="S">'submit'</span><span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        textarea: <span class="kwrd">function</span> (name, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> value = params &amp;&amp; <span class="S">'value'</span> <span class="kwrd">in</span> params ? params.value : resource<span class="gly">[</span>name<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'textarea'</span>, <span class="func">sanitizeHTML</span>(value), <span class="gly">{</span>name: <span class="func">makeName</span>(name), id: <span class="func">makeId</span>(name)<span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span>,</code></li><li class=""><code>        <span class="C">/*</span></code></li><li class=""><code><span class="C">         * Provides a select tag</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * In ejs:</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         *      &lt;%- form.select("state", states, {fieldname: 'name', fieldvalue: '_id'}) %&gt;</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * Possible params:</span></code></li><li class=""><code><span class="C">         * * blank: {STRING} Blank value to be added at the beginning of the list</span></code></li><li class=""><code><span class="C">         * * fieldname: {STRING} Sets the name of the field in "options" field where the displayed values can be found. Default: "value"</span></code></li><li class=""><code><span class="C">         * * fieldvalue: {STRING} Sets the name of the field in "options" field where the submitted values can be found. Default = fieldname</span></code></li><li class=""><code><span class="C">         * * multiple: Can be set to false if size &gt;1 to only select one value.</span></code></li><li class=""><code><span class="C">         * * select: Select a value. If fieldname and fieldvalue are different, the value is compared with fieldvalue otherwise with fieldname.</span></code></li><li class=""><code><span class="C">         * * size: Sets the displayed size of the select field</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * @author [Uli Wolf](https:~~~C22~~~</span></code></li><li class=""><code><span class="C">         * @param {String} name Name of the select tag</span></code></li><li class=""><code><span class="C">         * @param {Object} options Array of possible options</span></code></li><li class=""><code><span class="C">         * @param {Object} params Additional parameters</span></code></li><li class=""><code><span class="C">         */</span></code></li><li class=""><code>        select: <span class="kwrd">function</span> (name, options, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> options = options <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>            </code></li><li class=""><code>            <span class="C">// optional: Holds the displayed fieldname where the data can be found in 'options'</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> optionFieldname = params.fieldname <span class="gly">|</span><span class="gly">|</span> <span class="S">'value'</span>;</code></li><li class="uncovered"><code>            delete params.fieldname;</code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// optional: Holds the submittable fieldvalue where the data can be found in 'options'</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> optionFieldvalue = params.fieldvalue <span class="gly">|</span><span class="gly">|</span> optionFieldname;</code></li><li class="uncovered"><code>            delete params.fieldvalue;</code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// optional: Holds the number of entries that can be seen at once</span></code></li><li class=""><code>            <span class="C">// If size &gt; 1, multiple values can be selected (can be switched off via multiple:false)</span></code></li><li class=""><code>            <span class="C">// If size = 1, only one value is selectable (Drop-Down)</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.size === undef) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.size = 1;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (params.size &gt; 1) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (params.multiple === undef <span class="gly">|</span><span class="gly">|</span> params.multiple === true) <span class="gly">{</span></code></li><li class="uncovered"><code>                        params.multiple = <span class="S">'multiple'</span>;</code></li><li class=""><code>                    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                        delete params.multiple;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// optional: Preselect an entry</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.select === undef) <span class="gly">{</span></code></li><li class="uncovered"><code>                params.select = resource<span class="gly">[</span>name<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> optionSelected = params.select;</code></li><li class="uncovered"><code>            delete params.select;</code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// Render the options</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> innerOptions = <span class="S">''</span>;</code></li><li class=""><code></code></li><li class=""><code>            <span class="C">// optional: Add a blank field at the beginning</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.blank !== undef) <span class="gly">{</span></code></li><li class=""><code>                innerOptions += HelperSet.<span class="kwrd">prototype</span>.<span class="func">option_tag</span>(<span class="func">sanitizeHTML</span>(params.blank), <span class="gly">{</span>value: <span class="S">''</span><span class="gly">}</span>)</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">for</span> (<span class="kwrd">var</span> optionsNr <span class="kwrd">in</span> options) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> option = options<span class="gly">[</span>optionsNr<span class="gly">]</span>;</code></li><li class="uncovered"><code>                <span class="kwrd">var</span> optionParameters = <span class="kwrd">new</span> <span class="func">Array</span>();</code></li><li class=""><code></code></li><li class=""><code>                <span class="C">// Is the value in a seperate field?</span></code></li><li class=""><code>                <span class="kwrd">if</span> (option<span class="gly">[</span>optionFieldvalue<span class="gly">]</span> != option<span class="gly">[</span>optionFieldname<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    optionParameters.value = option<span class="gly">[</span>optionFieldvalue<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span>(<span class="func">activeValue</span>(option<span class="gly">[</span>optionFieldvalue<span class="gly">]</span>, optionSelected)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    optionParameters.selected = <span class="S">'selected'</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="C">// Generate the option Tags</span></code></li><li class=""><code>                innerOptions += HelperSet.<span class="kwrd">prototype</span>.<span class="func">option_tag</span>(<span class="func">sanitizeHTML</span>(option<span class="gly">[</span>optionFieldname<span class="gly">]</span>), optionParameters)</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="C">// Render the select</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> HelperSet.<span class="kwrd">prototype</span>.<span class="func">select_tag</span>(innerOptions, <span class="gly">{</span>name: <span class="func">makeName</span>(name), id: <span class="func">makeId</span>(name)<span class="gly">}</span>, params);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Form for resource helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @param {ModelInstance} resource</span></code></li><li class=""><code><span class="C"> * @param {Object} params</span></code></li><li class=""><code><span class="C"> * @param {Function} block</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.form<span class="kwrd">For</span> = <span class="kwrd">function</span> form<span class="kwrd">For</span>(resource, params, block) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> self = this;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> buf = arguments.callee.buf = arguments.callee.caller.buf;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (resource &amp;&amp; resource.modelName) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> params !== <span class="S">'object'</span>) <span class="gly">{</span></code></li><li class="covered"><code>            params = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!params.method) <span class="gly">{</span></code></li><li class="covered"><code>            params.method = <span class="S">'PUT'</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!params.action) <span class="gly">{</span></code></li><li class="covered"><code>            params.action = this.controller.app.railway.routeMapper.pathTo<span class="gly">[</span>railway.utils.<span class="func">underscore</span>(resource.modelName)<span class="gly">]</span>(resource);</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    this.<span class="func">formTag</span>(params, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        arguments.callee.buf = buf;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">if</span> (block) self.fields<span class="kwrd">For</span>(resource, block);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>HelperSet.<span class="kwrd">prototype</span>.form_<span class="kwrd">for</span> = HelperSet.<span class="kwrd">prototype</span>.form<span class="kwrd">For</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Input tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @param {String} text - inner html</span></code></li><li class=""><code><span class="C"> * @param {Object} params - set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param {Object} override - set params to override params in previous arg </span></code></li><li class=""><code><span class="C"> * @returns {String} Finalized input tag</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.input_tag = <span class="kwrd">function</span> (params, override) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'&lt;input'</span> + <span class="func">htmlTagParams</span>(params, override) + <span class="S">' /&gt;'</span>;</code><span class="hits">2</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Label tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Result:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     &lt;label&gt;text&lt;/label&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @param {String} text - inner html</span></code></li><li class=""><code><span class="C"> * @param {Object} params - set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param {Object} override - set params to override params in previous arg </span></code></li><li class=""><code><span class="C"> * @returns {String} Finalized label tag</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.label_tag = <span class="kwrd">function</span> (text, params, override) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'label'</span>, text, params, override);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Cross-site request forgery hidden inputs</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @returns {String} CSRF-Tag with parameters</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.csrf_tag = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'&lt;input type="hidden" name="'</span> + this.controller.req.csrfParam + <span class="S">'" value="'</span> + this.controller.req.csrfToken + <span class="S">'" /&gt;'</span>;</code><span class="hits">4</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Select tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Result:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     &lt;select&gt;innerOptions&lt;/select&gt;</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @author [Uli Wolf](https:~~~C34~~~</span></code></li><li class=""><code><span class="C"> * @param {String} innerOptions Inner html of the select tag</span></code></li><li class=""><code><span class="C"> * @param {Object} params Set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param {Object} override Set params to override params in previous arg </span></code></li><li class=""><code><span class="C"> * @returns {String} Finalized select tag</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.select_tag = <span class="kwrd">function</span> (innerOptions, params, override) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'select'</span>, innerOptions, params, override);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Option tag helper</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Result:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     &lt;option&gt;text&lt;/option&gt;</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * @methodOf HelperSet.prototype</span></code></li><li class=""><code><span class="C"> * @author [Uli Wolf](https:~~~C35~~~</span></code></li><li class=""><code><span class="C"> * @param {String} text Inner html</span></code></li><li class=""><code><span class="C"> * @param {Object} params Set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param {Object} override Set params to override params in previous arg </span></code></li><li class=""><code><span class="C"> * @returns {String} Finalized option tag</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.option_tag = <span class="kwrd">function</span> (text, params, override) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="func">genericTag</span>(<span class="S">'option'</span>, text, params, override);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * This helper returns method which calculates matching his single argument with</span></code></li><li class=""><code><span class="C"> * pattern and returns second arg</span></code></li><li class=""><code><span class="C"> * in case if result true, otherwise it returns third argument</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     var item = matcher(pageName, '&lt;li class="active"&gt;', '&lt;li&gt;');</span></code></li><li class=""><code><span class="C"> *     item('home') + 'Home&lt;/li&gt;'</span></code></li><li class=""><code><span class="C"> *     item('about-us') + 'About us&lt;/li&gt;'</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>HelperSet.<span class="kwrd">prototype</span>.matcher = <span class="kwrd">function</span> (pattern, positive, negative) <span class="gly">{</span></code></li><li class="uncovered"><code>    negative = negative <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class=""><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> (value) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> value === pattern ? positive : negative;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Private util methods</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Returns html code of one tag with contents</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name name of tag</span></code></li><li class=""><code><span class="C"> * @param {String} inner inner html</span></code></li><li class=""><code><span class="C"> * @param {Object} params set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param {Object} override set params to override params in previous arg</span></code></li><li class=""><code><span class="C"> * @returns {String} Finalized generic tag</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">genericTag</span>(name, inner, params, override) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'&lt;'</span> + name + <span class="func">htmlTagParams</span>(params, override) + <span class="S">'&gt;'</span> + inner + <span class="S">'&lt;/'</span> + name + <span class="S">'&gt;'</span>;</code><span class="hits">5</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Returns html code of a selfclosing tag</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} name name of tag</span></code></li><li class=""><code><span class="C"> * @param {Object} params set of tag attributes</span></code></li><li class=""><code><span class="C"> * @param {Object} override set params to override params in previous arg</span></code></li><li class=""><code><span class="C"> * @returns {String} Finalized generic selfclosing tag</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">genericTagSelfclosing</span>(name, params, override) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'&lt;'</span> + name + <span class="func">htmlTagParams</span>(params, override) + <span class="S">' /&gt;'</span>;</code><span class="hits">5</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Prefixes key with 'data-'</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} key name of key</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">dataParam</span>(key) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (this<span class="gly">[</span>key<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        this<span class="gly">[</span><span class="S">'data-'</span> + key<span class="gly">]</span> = this<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class="uncovered"><code>        delete this<span class="gly">[</span>key<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Compares a string against a string or an array</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @author [Uli Wolf](https:~~~C36~~~</span></code></li><li class=""><code><span class="C"> * @param {String} value Content of the String to be compared</span></code></li><li class=""><code><span class="C"> * @param {String|Array} selectvalue String or Array of possiblities to be equal to the first string</span></code></li><li class=""><code><span class="C"> * @returns {Boolean} True if the string matches the other string or array. False when not.</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">activeValue</span>(value, selectvalue) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> returnBool = false;</code></li><li class=""><code>    </code></li><li class=""><code>    <span class="C">// If this is an Array (e.g. when multiple values should be selected), iterate</span></code></li><li class=""><code>    <span class="kwrd">if</span> (Object.<span class="kwrd">prototype</span>.toString.<span class="func">call</span>(selectvalue) === <span class="S">'[object Array]'</span>) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// This is an Array (e.g. when multiple values should be selected), iterate</span></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> selectvalueNr <span class="kwrd">in</span> selectvalue) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// Cast to String as these might be objects.</span></code></li><li class=""><code>            <span class="kwrd">if</span> (<span class="func">String</span>(value) == <span class="func">String</span>(selectvalue<span class="gly">[</span>selectvalueNr<span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>                returnBool = true</code></li><li class="uncovered"><code>                <span class="kwrd">continue</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// This is just one entry</span></code></li><li class=""><code>        <span class="C">// Cast to String as these might be objects.</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="func">String</span>(value) == <span class="func">String</span>(selectvalue)) <span class="gly">{</span></code></li><li class=""><code>            returnBool = true</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> returnBool;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Escape &amp;, &lt; and &gt; symbols</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * @param {String} html String with possible HTML-Elements</span></code></li><li class=""><code><span class="C"> * @returns {String} resulting string with escaped characters</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">sanitizeHTML</span>(html) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> html.<span class="func">replace</span>(/&amp;/g, <span class="S">'&amp;amp;'</span>).<span class="func">replace</span>(/&gt;/g, <span class="S">'&amp;gt;'</span>).<span class="func">replace</span>(/&lt;/g, <span class="S">'&amp;lt;'</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>HelperSet.<span class="kwrd">prototype</span>.sanitize = sanitizeHTML;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Checks if the environment is production</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * @returns {Boolean} True if production, otherwise false</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">checkProd</span>(app) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> app.settings.env === <span class="S">'production'</span>;</code><span class="hits">10</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Provides the link to a file. Checks if a file needs to be suffixed with a timestamp</span></code></li><li class=""><code><span class="C"> * </span></code></li><li class=""><code><span class="C"> * @param {String} type Type of the file, e.g. css or js</span></code></li><li class=""><code><span class="C"> * @param {String} file name (local file) or link (external) to the file</span></code></li><li class=""><code><span class="C"> * @returns {String} Final Link to the file</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">checkFile</span>(app, type, file) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> isExternalFile = regexps.isHttp.<span class="func">test</span>(file),</code></li><li class=""><code>    isCached         = file.<span class="func">match</span>(regexps.cached),</code></li><li class=""><code>    href             = !isExternalFile ? paths<span class="gly">[</span>type<span class="gly">]</span> + file + exts<span class="gly">[</span>type<span class="gly">]</span> : file,</code></li><li class="covered"><code>    isProd           = <span class="func">checkProd</span>(app);</code><span class="hits">10</span></li><li class=""><code>    <span class="kwrd">if</span> (!isCached &amp;&amp; !isProd &amp;&amp; !isExternalFile &amp;&amp; !app.<span class="func">disabled</span>(<span class="S">'assets timestamps'</span>)) <span class="gly">{</span></code></li><li class=""><code>        href += <span class="S">'?'</span> + Date.<span class="func">now</span>()</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> appprefix = <span class="S">''</span>;</code><span class="hits">10</span></li><li class=""><code>    <span class="kwrd">if</span> (app.path) <span class="gly">{</span></code></li><li class="covered"><code>        appprefix = app.<span class="func">path</span>();</code><span class="hits">10</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        appprefix = app.<span class="func">set</span>(<span class="S">'basepath'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> isExternalFile ? href : appprefix + href;</code><span class="hits">10</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-onrailway-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-onrailway-js" class="filename trigger" name="lib-onrailway-js">lib/onrailway.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 63%"><strong>63%</strong> [62/99]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> singularize = <span class="func">require</span>(<span class="S">"../vendor/inflection"</span>).singularize;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> safe_merge = utils.safe_merge;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Map = <span class="func">require</span>(<span class="S">'railway-routes'</span>).Map;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> existsSync = fs.existsSync <span class="gly">|</span><span class="gly">|</span> path.existsSync;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> exists = fs.exists <span class="gly">|</span><span class="gly">|</span> path.exists;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> cs = <span class="func">require</span>(<span class="S">'coffee-script'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Module = <span class="func">require</span>(<span class="S">'module'</span>).Module;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Global railway API singleton.</span></code></li><li class=""><code><span class="C"> * Available everywhere in project.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @member railway.locales - localization module</span></code></li><li class=""><code><span class="C"> * @member railway.utils - railway utilities (stylize, runCode, etc..)</span></code></li><li class=""><code><span class="C"> * @see railway_utils.html#</span></code></li><li class=""><code><span class="C"> * @member railway.controller</span></code></li><li class=""><code><span class="C"> * @see /1602/kontroller</span></code></li><li class=""><code><span class="C"> * @member railway.extensions</span></code></li><li class=""><code><span class="C"> * @see extensions.html#</span></code></li><li class=""><code><span class="C"> * @member railway.generators</span></code></li><li class=""><code><span class="C"> * @see generators.html#</span></code></li><li class=""><code><span class="C"> * @member railway.tools</span></code></li><li class=""><code><span class="C"> * @see tools.html#</span></code></li><li class=""><code><span class="C"> * @member railway.logger</span></code></li><li class=""><code><span class="C"> * @see logger.html#</span></code></li><li class=""><code><span class="C"> * @member railway.helpers</span></code></li><li class=""><code><span class="C"> * @see helpers.html#</span></code></li><li class=""><code><span class="C"> * @member railway.models</span></code></li><li class=""><code><span class="C"> * @see model.html#</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Railway</span>(app) <span class="gly">{</span></code></li><li class="covered"><code>    app.railway = this;</code><span class="hits">1</span></li><li class=""><code>    this.<span class="func">__defineGetter__</span>(<span class="S">'rootModule'</span>, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> module.parent;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.app = app;</code><span class="hits">1</span></li><li class="covered"><code>    this.root = app.root;</code><span class="hits">1</span></li><li class="covered"><code>    this.utils       = utils;</code><span class="hits">1</span></li><li class="covered"><code>    this.logger      = <span class="func">require</span>(<span class="S">'./logger'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.logger.<span class="func">init</span>(this);</code><span class="hits">1</span></li><li class="covered"><code>    this.ControllerBridge = <span class="func">require</span>(<span class="S">'./controller-bridge'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.controller  = <span class="func">require</span>(<span class="S">'kontroller'</span>).BaseController;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    this.structure   = <span class="func">require</span>(<span class="S">'./structure'</span>)(this);</code><span class="hits">1</span></li><li class="covered"><code>    this.locales     = <span class="func">require</span>(<span class="S">'./locales'</span>)(this);</code><span class="hits">1</span></li><li class="covered"><code>    this.controllerBridge = <span class="kwrd">new</span> this.<span class="func">ControllerBridge</span>(this);</code><span class="hits">1</span></li><li class="covered"><code>    this.extensions  = <span class="func">require</span>(<span class="S">'./extensions'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.generators  = <span class="func">require</span>(<span class="S">'./generators'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.tools       = <span class="func">require</span>(<span class="S">'./tools'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.routeMapper = <span class="kwrd">new</span> <span class="func">Map</span>(app, this.controllerBridge.uniCaller.<span class="func">bind</span>(this.controllerBridge));</code><span class="hits">1</span></li><li class="covered"><code>    this.helpers     = <span class="func">require</span>(<span class="S">'./helpers'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    this.models = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>Railway.<span class="kwrd">prototype</span>.version = <span class="func">require</span>(<span class="S">'../package'</span>).version;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize railway application:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *  - load modules</span></code></li><li class=""><code><span class="C"> *  - run configurators (config/environment, config/environments/{env})</span></code></li><li class=""><code><span class="C"> *  - init controllers</span></code></li><li class=""><code><span class="C"> *  - init extensions (including ORM and db/schema)</span></code></li><li class=""><code><span class="C"> *  - init models</span></code></li><li class=""><code><span class="C"> *  - run initializers `config/initializers/*`</span></code></li><li class=""><code><span class="C"> *  - add routes</span></code></li><li class=""><code><span class="C"> *  - start http server</span></code></li><li class=""><code><span class="C"> *  - locales</span></code></li><li class=""><code><span class="C"> *  - loggers</span></code></li><li class=""><code><span class="C"> *  - observers</span></code></li><li class=""><code><span class="C"> *  - assets</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> <span class="func">initRailway</span>(app) <span class="gly">{</span></code></li><li class="covered"><code>    app.root = app.root <span class="gly">|</span><span class="gly">|</span> process.<span class="func">cwd</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// create API publishing object</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> railway = <span class="kwrd">new</span> <span class="func">Railway</span>(app);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// run environment.{js|coffee} and environments/{test|development|production}.{js|coffee}</span></code></li><li class="covered"><code>    <span class="func">configureApp</span>(railway);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// controllers should be loaded before extensions</span></code></li><li class=""><code>    <span class="C">// railway.controller.init(root);</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// extensions should be loaded before server startup</span></code></li><li class="covered"><code>    railway.<span class="func">extensions</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">existsSync</span>(app.root + <span class="S">'/config'</span>) &amp;&amp; (<span class="func">existsSync</span>(app.root + <span class="S">'/config/routes.js'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="func">existsSync</span>(app.root + <span class="S">'/config/routes.coffee'</span>))) <span class="gly">{</span></code></li><li class="uncovered"><code>        railway.routeMapper.<span class="func">addRoutes</span>(app.root + <span class="S">'/config/routes'</span>, railway.controllerBridge.uniCaller.<span class="func">bind</span>(railway.controllerBridge));</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// everything else can be done after starting server</span></code></li><li class=""><code>    process.<span class="func">nextTick</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        railway.structure = railway.<span class="func">structure</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// init models in app/models/*</span></code></li><li class="covered"><code>        <span class="func">require</span>(<span class="S">'./models'</span>).<span class="func">init</span>(railway);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="C">// run config/initializers/*</span></code></li><li class="covered"><code>        <span class="func">runInitializers</span>(railway);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>        railway.<span class="func">locales</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (railway.app.<span class="func">enabled</span>(<span class="S">'merge javascripts'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">ensureDirClean</span>(railway.app.root + <span class="S">'/public'</span> + railway.app.<span class="func">set</span>(<span class="S">'jsDirectory'</span>), <span class="S">'cache'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (railway.app.<span class="func">enabled</span>(<span class="S">'merge stylesheets'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">ensureDirClean</span>(railway.app.root + <span class="S">'/public'</span> + railway.app.<span class="func">set</span>(<span class="S">'cssDirectory'</span>), <span class="S">'cache'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> railway;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Create http server object. Automatically hook up SSL keys stored in</span></code></li><li class=""><code><span class="C"> * app.root/config/tsl.{cert|key}</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {Object} options: {root: __dirname, key: 'path/to/tsl.key', cert: 'path/to/tsl.cert'}</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.createServer = <span class="kwrd">function</span> (options) <span class="gly">{</span></code></li><li class="covered"><code>    options = options <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> options === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        options = <span class="gly">{</span>root: options<span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> express = <span class="func">require</span>(<span class="S">'express'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> server;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> express === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="covered"><code>        server = express;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        server = express.createServer;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">var</span> keys, app, root = options.root <span class="gly">|</span><span class="gly">|</span> process.<span class="func">cwd</span>(),</code></li><li class=""><code>        key = options.key <span class="gly">|</span><span class="gly">|</span> root + <span class="S">'/config/tsl.key'</span>,</code></li><li class="covered"><code>        cert = options.cert <span class="gly">|</span><span class="gly">|</span> root + <span class="S">'/config/tsl.cert'</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">existsSync</span>(key) &amp;&amp; <span class="func">existsSync</span>(cert)) <span class="gly">{</span></code></li><li class=""><code>        keys = <span class="gly">{</span></code></li><li class=""><code>            key: fs.<span class="func">readFileSync</span>(key).<span class="func">toString</span>(<span class="S">'utf8'</span>),</code></li><li class=""><code>            cert: fs.<span class="func">readFileSync</span>(cert).<span class="func">toString</span>(<span class="S">'utf8'</span>)</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (keys) <span class="gly">{</span></code></li><li class="uncovered"><code>        app = <span class="func">server</span>(keys);</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        app = <span class="func">server</span>();</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    app.root = root;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> rw = exports.<span class="func">init</span>(app);</code><span class="hits">1</span></li><li class="covered"><code>    app.express2 = express.version.<span class="func">match</span>(/^2/);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> app;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Run app configutators in `config/environment` and `config/environments/{env}`.</span></code></li><li class=""><code><span class="C"> * Also try to monkey patch ejs and jade. **weird**</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">configureApp</span>(railway) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> app = railway.app;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> root = railway.root;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> mainEnv = root + <span class="S">'/config/environment'</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    app.<span class="func">set</span>(<span class="S">'views'</span>, root + <span class="S">'/app/views'</span>);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">requireIfExists</span>(app, mainEnv + <span class="S">'.js'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="func">requireIfExists</span>(app, mainEnv + <span class="S">'.coffee'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> supportEnv = app.root + <span class="S">'/config/environments/'</span> + app.settings.env;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="func">requireIfExists</span>(app, supportEnv + <span class="S">'.js'</span>) <span class="gly">|</span><span class="gly">|</span> <span class="func">requireIfExists</span>(app, supportEnv + <span class="S">'.coffee'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// TODO: remove monkey-patching from here</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span> == <span class="S">'ejs'</span> &amp;&amp; (!app.extensions <span class="gly">|</span><span class="gly">|</span> !app.extensions<span class="gly">[</span><span class="S">'ejs-ext'</span><span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// monkey patch ejs</span></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> ejs = <span class="func">require</span>(<span class="S">'ejs'</span>), old_parse = ejs.parse;</code></li><li class=""><code>            ejs.parse = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> str = old_parse.<span class="func">apply</span>(this, Array.<span class="kwrd">prototype</span>.slice.<span class="func">call</span>(arguments));</code></li><li class="uncovered"><code>                <span class="kwrd">return</span> str.<span class="func">replace</span>(<span class="S">'var buf = [];'</span>, <span class="S">'var buf = []; arguments.callee.buf = buf;'</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (app.settings<span class="gly">[</span><span class="S">'view engine'</span><span class="gly">]</span> == <span class="S">'jade'</span> &amp;&amp; (!app.extensions <span class="gly">|</span><span class="gly">|</span> !app.extensions<span class="gly">[</span><span class="S">'jade-ext'</span><span class="gly">]</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="C">// monkey patch jade</span></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> jade = <span class="func">require</span>(<span class="S">'jade'</span>), old_parse = jade.Compiler.<span class="kwrd">prototype</span>.compile;</code></li><li class=""><code>            jade.Compiler.<span class="kwrd">prototype</span>.compile = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> str = old_parse.<span class="func">apply</span>(this, Array.<span class="kwrd">prototype</span>.slice.<span class="func">call</span>(arguments));</code></li><li class=""><code>                <span class="C">// console.log(str);</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> <span class="S">'arguments.callee.buf = buf;'</span> + str;</code></li><li class="uncovered"><code>            <span class="gly">}</span>;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Require `module` if it exists</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} module - path to file</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">requireIfExists</span>(app, module) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(module)) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">evalInContextOf</span>(app, module);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> true;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span> false;</code><span class="hits">4</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">evalInContextOf</span>(app, filename) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> code = fs.<span class="func">readFileSync</span>(filename).<span class="func">toString</span>();</code></li><li class=""><code>    <span class="kwrd">if</span> (filename.<span class="func">match</span>(/\.coffee/)) <span class="gly">{</span></code></li><li class="uncovered"><code>        code = cs.<span class="func">compile</span>(code);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> fn = <span class="kwrd">new</span> <span class="kwrd">Function</span>(<span class="S">'app'</span>, <span class="S">'railway'</span>, <span class="S">'__dirname'</span>, <span class="S">'__filename'</span>, <span class="S">'require'</span>, code);</code></li><li class=""><code>    fn.<span class="func">call</span>(null, app, app.railway, path.<span class="func">dirname</span>(filename), filename, <span class="kwrd">function</span> (path) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> Module.<span class="func">_load</span>(path, <span class="gly">{</span>id: filename, filename: filename<span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Run initializers in sandbox mode</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">runInitializers</span>(rw) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> context = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i <span class="kwrd">in</span> rw.models) <span class="gly">{</span></code></li><li class="uncovered"><code>        context<span class="gly">[</span>i<span class="gly">]</span> = rw.models<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> initializersPath = root + <span class="S">'/config/initializers/'</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">if</span> (<span class="func">existsSync</span>(initializersPath)) <span class="gly">{</span></code></li><li class=""><code>        fs.<span class="func">readdirSync</span>(initializersPath).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (file.<span class="func">match</span>(/^\./)) <span class="kwrd">return</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> filename = initializersPath + file;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> code = fs.<span class="func">readFileSync</span>(filename).<span class="func">toString</span>();</code></li><li class=""><code>            <span class="kwrd">if</span> (filename.<span class="func">match</span>(/\.coffee/)) <span class="gly">{</span></code></li><li class="uncovered"><code>                code = cs.<span class="func">compile</span>(code);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">var</span> fn = <span class="kwrd">new</span> <span class="kwrd">Function</span>(</code></li><li class=""><code>                <span class="S">'context'</span>, <span class="S">'__filename'</span>, <span class="S">'__dirname'</span>, <span class="S">'require'</span>,</code></li><li class=""><code>                <span class="S">'with (context) { (function () { '</span> + code + <span class="S">' })() }'</span></code></li><li class="uncovered"><code>            );</code></li><li class=""><code>            <span class="func">fn</span>(context, filename, path.<span class="func">dirname</span>(filename), <span class="kwrd">function</span> (path) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> Module.<span class="func">_load</span>(path, <span class="gly">{</span>id: filename, filename: filename<span class="gly">}</span>);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Cleanup or create dir</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">ensureDirClean</span>(dir, prefix) <span class="gly">{</span></code></li><li class=""><code>    <span class="func">exists</span>(dir, <span class="kwrd">function</span> (exists) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (exists) <span class="gly">{</span></code></li><li class=""><code>            fs.<span class="func">readdir</span>(dir, <span class="kwrd">function</span> (err, files) <span class="gly">{</span></code></li><li class=""><code>                files.<span class="func">filter</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> file.<span class="func">indexOf</span>(prefix + <span class="S">'_'</span>) === 0;</code></li><li class=""><code>                <span class="gly">}</span>).<span class="func">map</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> path.jo<span class="kwrd">in</span>(dir, file);</code></li><li class="uncovered"><code>                <span class="gly">}</span>).<span class="func">forEach</span>(fs.unlink);</code></li><li class="uncovered"><code>            <span class="gly">}</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            fs.<span class="func">mkdir</span>(dir, 0755);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-tools-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-tools-js" class="filename trigger" name="lib-tools-js">lib/tools.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 17%"><strong>17%</strong> [15/88]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> readline = <span class="func">require</span>(<span class="S">'readline'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> childProcess = <span class="func">require</span>(<span class="S">'child_process'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> sys = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> util = <span class="func">require</span>(<span class="S">'util'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Print routing map. Optionally accepts `filter` param, allowing to filter</span></code></li><li class=""><code><span class="C"> * output by method or helper name</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param filter</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway routes</span></code></li><li class=""><code><span class="C"> *  projects GET    /projects           projects#index</span></code></li><li class=""><code><span class="C"> *    update ALL    /:user/:repo/update doc#update</span></code></li><li class=""><code><span class="C"> *           GET    /:user/:repo        doc#make</span></code></li><li class=""><code><span class="C"> *         * GET    /:user/:repo/*      doc#make</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * same but filtered to show GET routes only</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway routes get</span></code></li><li class=""><code><span class="C"> *  projects GET    /projects           projects#index</span></code></li><li class=""><code><span class="C"> *           GET    /:user/:repo        doc#make</span></code></li><li class=""><code><span class="C"> *         * GET    /:user/:repo/*      doc#make</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * same but filtered to show routes with helper name contains `pro`</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway routes get</span></code></li><li class=""><code><span class="C"> *  projects GET    /projects           projects#index</span></code></li><li class=""><code><span class="C"> w ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">routes</span>(railway, args) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> mapper = railway.routeMapper;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> addSpaces = utils.addSpaces;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> dump = mapper.dump;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> max_len = 0, helper_max_len = 0;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> filter = (args.<span class="func">shift</span>() <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>).toUpper<span class="kwrd">Case</span>();</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> filtered = <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>    dump.<span class="func">forEach</span>(<span class="kwrd">function</span> (data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> method = data.method.toUpper<span class="kwrd">Case</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (!filter <span class="gly">|</span><span class="gly">|</span> filter === method <span class="gly">|</span><span class="gly">|</span> data.helper.toUpper<span class="kwrd">Case</span>().<span class="func">search</span>(filter) !== -1) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (data.path.length &gt; max_len) <span class="gly">{</span></code></li><li class="uncovered"><code>                max_len = data.path.length;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (data.helper.length &gt; helper_max_len) <span class="gly">{</span></code></li><li class="uncovered"><code>                helper_max_len = data.helper.length;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            filtered.<span class="func">push</span>(data);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>    filtered.<span class="func">forEach</span>(<span class="kwrd">function</span> (data) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> method = data.method.toUpper<span class="kwrd">Case</span>();</code></li><li class=""><code>        console.<span class="func">log</span>(</code></li><li class=""><code>            <span class="func">addSpaces</span>(data.helper, helper_max_len + 1, true) + <span class="S">' '</span> +</code></li><li class=""><code>            <span class="func">addSpaces</span>(method, 7) +</code></li><li class=""><code>            <span class="func">addSpaces</span>(data.path, max_len + 1) +</code></li><li class=""><code>            data.file + <span class="S">"#"</span> + data.action</code></li><li class="uncovered"><code>        );</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> true;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.routes = routes;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>routes.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut:    <span class="S">'r'</span>,</code></li><li class=""><code>    usage:       <span class="S">'routes [filter]'</span>,</code></li><li class=""><code>    description: <span class="S">'Display application routes'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Debug console.</span></code></li><li class=""><code><span class="C"> * node REPL console with railway bindings</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Predefined helpers:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *  - `c` - callback, assigning it's arguments to _0 _1 .. _N variables</span></code></li><li class=""><code><span class="C"> *  - `reload` - reload models</span></code></li><li class=""><code><span class="C"> *  - `exit` - quit repl</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Usage Example:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * $ railway console</span></code></li><li class=""><code><span class="C"> * railway&gt; User.all(c)</span></code></li><li class=""><code><span class="C"> * undefined</span></code></li><li class=""><code><span class="C"> * railway&gt; [ [ 'hgetall', 'User:68' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:69' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:70' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:71' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:72' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:73' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:74' ],</span></code></li><li class=""><code><span class="C"> *  [ 'hgetall', 'User:75' ] ] '[2ms]'</span></code></li><li class=""><code><span class="C"> *  Callback called with 2 arguments:</span></code></li><li class=""><code><span class="C"> *  _0 = null</span></code></li><li class=""><code><span class="C"> *  _1 = [object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object],[object Object]</span></code></li><li class=""><code><span class="C"> * railway&gt; _1[0].toObject()</span></code></li><li class=""><code><span class="C"> * { id: '68',</span></code></li><li class=""><code><span class="C"> *   githubId: null,</span></code></li><li class=""><code><span class="C"> *   displayName: null,</span></code></li><li class=""><code><span class="C"> *   username: null,</span></code></li><li class=""><code><span class="C"> *   avatar: null }</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">railwayConsole</span>(railway, args) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> ctx = <span class="func">require</span>(<span class="S">'repl'</span>).<span class="func">start</span>(<span class="S">'railway&gt; '</span>).context;</code></li><li class=""><code></code></li><li class=""><code>    ctx.reload = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        global.models = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>        ctx.app = railway.app;</code></li><li class=""><code>        <span class="C">// ctx.app.reloadModels();</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> m <span class="kwrd">in</span> models) <span class="gly">{</span></code></li><li class="uncovered"><code>            ctx<span class="gly">[</span>m<span class="gly">]</span> = models<span class="gly">[</span>m<span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    ctx.c = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">var</span> l = arguments.length,</code></li><li class=""><code>            message = <span class="S">'Callback called with '</span> + l +</code></li><li class="uncovered"><code>                <span class="S">' argument'</span> + (l === 1 ? <span class="S">''</span> : <span class="S">'s'</span>) + (l &gt; 0 ? <span class="S">':\n'</span> : <span class="S">''</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> i = 0; i &lt; 10; i++) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (i &lt; arguments.length) <span class="gly">{</span></code></li><li class="uncovered"><code>                ctx<span class="gly">[</span><span class="S">'_'</span> + i<span class="gly">]</span> = arguments<span class="gly">[</span>i<span class="gly">]</span>;</code></li><li class="uncovered"><code>                message += <span class="S">'_'</span> + i + <span class="S">' = '</span> + arguments<span class="gly">[</span>i<span class="gly">]</span> + <span class="S">'\n'</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (ctx.<span class="func">hasOwnProperty</span>(<span class="S">'_'</span> + i)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    delete ctx<span class="gly">[</span><span class="S">'_'</span> + i<span class="gly">]</span>;</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(message);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    ctx.exit = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>        process.<span class="func">exit</span>(0);</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>    process.<span class="func">nextTick</span>(ctx.reload);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> false;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.console = railwayConsole;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>railwayConsole.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut:    <span class="S">'c'</span>,</code></li><li class=""><code>    usage:       <span class="S">'console'</span>,</code></li><li class=""><code>    description: <span class="S">'Debug console'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li><li class=""><code>exports.dbconsole = <span class="kwrd">function</span> <span class="func">dbconsole</span>(railway, args) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> db = childProcess.<span class="func">spawn</span>(<span class="S">'mongo'</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> rli = readline.<span class="func">createInterface</span>(process.std<span class="kwrd">in</span>, process.stdout, autocomplete);</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> data = <span class="S">''</span>;</code></li><li class=""><code>    db.stdout.<span class="func">on</span>(<span class="S">'data'</span>, <span class="kwrd">function</span> (chunk) <span class="gly">{</span></code></li><li class="uncovered"><code>        data += chunk;</code></li><li class="uncovered"><code>        <span class="func">write</span>();</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">write</span>() <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (write.to) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">clearTimeout</span>(write.to);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="func">setTimeout</span>(<span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>            process.stdout.<span class="func">write</span>(data);</code></li><li class="uncovered"><code>            rli.<span class="func">prompt</span>();</code></li><li class="uncovered"><code>            data = <span class="S">''</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>, 50);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    rli.<span class="func">on</span>(<span class="S">'SIGINT'</span>, rli.close.<span class="func">bind</span>(rli));</code></li><li class="uncovered"><code>    rli.<span class="func">addListener</span>(<span class="S">'close'</span>, process.exit);</code></li><li class="uncovered"><code>    rli.<span class="func">setPrompt</span>(<span class="S">'mongo &gt; '</span>);</code></li><li class=""><code>    rli.<span class="func">addListener</span>(<span class="S">'line'</span>, <span class="kwrd">function</span> (line) <span class="gly">{</span></code></li><li class="uncovered"><code>        db.std<span class="kwrd">in</span>.<span class="func">write</span>(line + <span class="S">'\n'</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code>    <span class="C">// console.log(db);</span></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">autocomplete</span>(input) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="gly">[</span><span class="gly">[</span><span class="S">'help'</span>, <span class="S">'test'</span><span class="gly">]</span>, input<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Railway server. Command optionally accept PORT argument</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * railway server 8000  # run server on 8000 port</span></code></li><li class=""><code><span class="C"> * railway s 3000       # run server on 3000 port using shorter alias</span></code></li><li class=""><code><span class="C"> * PORT=80 railway s    # run server on 80 port usin env var PORT</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">server</span>(railway, args) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> port = process.env.PORT <span class="gly">|</span><span class="gly">|</span> args.<span class="func">shift</span>() <span class="gly">|</span><span class="gly">|</span> 3000;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> app = railway.app;</code></li><li class="uncovered"><code>    app.<span class="func">listen</span>(port);</code></li><li class="uncovered"><code>    console.<span class="func">log</span>(<span class="S">"Railway server listening on port %d within %s environment"</span>, port, app.settings.env);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> false;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.server = server;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>server.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut: <span class="S">'s'</span>,</code></li><li class=""><code>    usage: <span class="S">'server [port]'</span>,</code></li><li class=""><code>    description: <span class="S">'Run railway server'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Install railway extension</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">install</span>(railway, args) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> app = railway.app;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> what = args.<span class="func">shift</span>(), where = args.<span class="func">shift</span>();</code></li><li class=""><code>    <span class="kwrd">if</span> (!what <span class="gly">|</span><span class="gly">|</span> !what.<span class="func">match</span>(/\.git$/)) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'What do you want to install?'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> true;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!where) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> m = what.<span class="func">match</span>(/\/(<span class="gly">[</span>^\/<span class="gly">]</span>*?)\.git/);</code></li><li class="uncovered"><code>        where = m<span class="gly">[</span>1<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!utils.<span class="func">existsSync</span>(app.root + <span class="S">'/node_modules'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        fs.<span class="func">mkdirSync</span>(app.root + <span class="S">'/node_modules'</span>);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> command = <span class="S">'clone'</span>;</code></li><li class=""><code>    <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(app.root + <span class="S">'/.git'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>        command = <span class="S">'submodule add'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    console.<span class="func">log</span>(<span class="S">'Installing '</span> + where + <span class="S">' extension from '</span> + what + <span class="S">' repo to node_modules/'</span> + where);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> cp = <span class="func">require</span>(<span class="S">'child_process'</span>);</code></li><li class=""><code>    cp.<span class="func">exec</span>(<span class="S">'git '</span> + command + <span class="S">' '</span> + what + <span class="S">' node_modules/'</span> + where, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(app.root + <span class="S">'/npmfile.coffee'</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>            cp.<span class="func">exec</span>(<span class="S">'echo "require \''</span> + where + <span class="S">'\'" &gt;&gt; npmfile.coffee'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Patched npmfile.coffee'</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            cp.<span class="func">exec</span>(<span class="S">'echo "require(\''</span> + where + <span class="S">'\');" &gt;&gt; npmfile.js'</span>);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Patched npmfile.js'</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> installScript = app.root + <span class="S">'/node_modules/'</span> + where + <span class="S">'/install.js'</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(installScript)) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Running installation script'</span>);</code></li><li class="uncovered"><code>            <span class="func">require</span>(installScript);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            process.<span class="func">exit</span>(0);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> false;</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>exports.install = install;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>install.help = <span class="gly">{</span></code></li><li class=""><code>    shortcut: <span class="S">'x'</span>,</code></li><li class=""><code>    usage: <span class="S">'install gitUrl [extName]'</span>,</code></li><li class=""><code>    description: <span class="S">'Install railway eXtension'</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-controller-bridge-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-controller-bridge-js" class="filename trigger" name="lib-controller-bridge-js">lib/controller-bridge.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 62%"><strong>62%</strong> [45/73]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> exts = <span class="func">require</span>(<span class="S">'./controller-extensions'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> pool = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> $ = utils.stylize.$;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> log = utils.debug;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="kwrd">var</span> ctlSuffix = /_controller\.(js<span class="gly">|</span>coffee)/g;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>module.exports = ControllerBrigde;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">ControllerBrigde</span>(rw) <span class="gly">{</span></code></li><li class="covered"><code>    this.railway = rw;</code><span class="hits">1</span></li><li class="covered"><code>    this.root = rw.root + <span class="S">'/app/controllers'</span>;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>ControllerBrigde.config = <span class="gly">{</span></code></li><li class=""><code>    subdoma<span class="kwrd">in</span>: <span class="gly">{</span></code></li><li class=""><code>        tld: 2</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>ControllerBrigde.poolSize = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(pool).<span class="func">forEach</span>(<span class="kwrd">function</span> (i) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(i, pool<span class="gly">[</span>i<span class="gly">]</span>.length);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// TODO: remove NS param, move subdomain logic to railway-routes</span></code></li><li class=""><code>ControllerBrigde.<span class="kwrd">prototype</span>.uniCaller = <span class="kwrd">function</span> (ns, controller, action, params) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> app = this.railway.app;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> (req, res, next) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">var</span> subdoma<span class="kwrd">in</span> = req.headers.host</code></li><li class=""><code>            .<span class="func">split</span>(<span class="S">'.'</span>)</code></li><li class=""><code>            .<span class="func">slice</span>(0, -1 * ControllerBrigde.config.subdoma<span class="kwrd">in</span>.tld)</code></li><li class="uncovered"><code>        req.subdoma<span class="kwrd">in</span> = subdoma<span class="kwrd">in</span>.jo<span class="kwrd">in</span>(<span class="S">'.'</span>);</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (params &amp;&amp; params.subdoma<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (params.subdoma<span class="kwrd">in</span> !== req.subdoma<span class="kwrd">in</span>) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">if</span> (params.subdoma<span class="kwrd">in</span>.<span class="func">match</span>(/\*/)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> matched = true;</code></li><li class=""><code>                    params.subdoma<span class="kwrd">in</span>.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (part, i) <span class="gly">{</span></code></li><li class="uncovered"><code>                        <span class="kwrd">if</span> (part === <span class="S">'*'</span>) <span class="kwrd">return</span>;</code></li><li class="uncovered"><code>                        <span class="kwrd">if</span> (part !== subdoma<span class="kwrd">in</span><span class="gly">[</span>i<span class="gly">]</span>) matched = false;</code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class=""><code>                    <span class="kwrd">if</span> (!matched) <span class="kwrd">return</span> <span class="func">next</span>(); <span class="C">// next route</span></code></li><li class="uncovered"><code>                <span class="gly">}</span> else <span class="kwrd">return</span> <span class="func">next</span>();</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ctl = this.<span class="func">loadController</span>(ns + (controller <span class="gly">|</span><span class="gly">|</span> req.params.controller));</code></li><li class=""><code>        <span class="kwrd">if</span> (app.<span class="func">disabled</span>(<span class="S">'model cache'</span>)) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// TODO: reloadModels should work without any params</span></code></li><li class=""><code>            <span class="C">// it just should remember all paths</span></code></li><li class=""><code>            <span class="C">// called previously with</span></code></li><li class=""><code>            <span class="C">// app.reloadModels(this.root + '/app/models/');</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        ctl.<span class="func">perform</span>(action <span class="gly">|</span><span class="gly">|</span> req.params.action, req, res, <span class="kwrd">function</span> (err) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// console.log((new Error).stack);</span></code></li><li class=""><code>            <span class="kwrd">if</span> (ctl._backToPool) <span class="gly">{</span></code></li><li class="uncovered"><code>                ctl.<span class="func">_backToPool</span>();</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                ctl = null;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (err) <span class="func">next</span>(err);</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>.<span class="func">bind</span>(this);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>ControllerBrigde.<span class="kwrd">prototype</span>.loadController = <span class="kwrd">function</span> (controllerFullName) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this.railway.app.<span class="func">enabled</span>(<span class="S">'watch'</span>)) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!pool<span class="gly">[</span>controllerFullName<span class="gly">]</span>) <span class="gly">{</span></code></li><li class="covered"><code>            pool<span class="gly">[</span>controllerFullName<span class="gly">]</span> = <span class="gly">[</span><span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (pool<span class="gly">[</span>controllerFullName<span class="gly">]</span>.length) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> pool<span class="gly">[</span>controllerFullName<span class="gly">]</span>.<span class="func">shift</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> ctl = this.<span class="func">getInstance</span>(controllerFullName, exts);</code><span class="hits">1</span></li><li class=""><code>        ctl._backToPool = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="uncovered"><code>            pool<span class="gly">[</span>controllerFullName<span class="gly">]</span>.<span class="func">push</span>(ctl);</code></li><li class="covered"><code>        <span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">return</span> ctl;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> this.<span class="func">getInstance</span>(controllerFullName, exts);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>ControllerBrigde.<span class="kwrd">prototype</span>.getInstance = <span class="kwrd">function</span> <span class="func">getInstance</span>(name, exts) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> railway = this.railway;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> app = railway.app;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">var</span> code = railway.structure.controllers<span class="gly">[</span>name + <span class="S">'_controller'</span><span class="gly">]</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// create blank controller</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> Controller = railway.controller.<span class="func">constructClass</span>(name);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// add controller extensions</span></code></li><li class=""><code>    <span class="kwrd">if</span> (exts) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">keys</span>(exts).<span class="func">forEach</span>(<span class="kwrd">function</span> (k) <span class="gly">{</span></code></li><li class="covered"><code>            Controller.<span class="kwrd">prototype</span><span class="gly">[</span>k<span class="gly">]</span> = exts<span class="gly">[</span>k<span class="gly">]</span>;</code><span class="hits">4</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    Controller.<span class="kwrd">prototype</span>.railway = railway;</code><span class="hits">1</span></li><li class="covered"><code>    Controller.<span class="kwrd">prototype</span>.app = app;</code><span class="hits">1</span></li><li class="covered"><code>    Controller.<span class="kwrd">prototype</span>.pathTo = railway.routeMapper.pathTo;</code><span class="hits">1</span></li><li class="covered"><code>    Controller.<span class="kwrd">prototype</span>.path_to = railway.routeMapper.pathTo;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// add models</span></code></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> m <span class="kwrd">in</span> this.railway.models) <span class="gly">{</span></code></li><li class="uncovered"><code>        Controller.<span class="kwrd">prototype</span><span class="gly">[</span>m<span class="gly">]</span> = railway.models<span class="gly">[</span>m<span class="gly">]</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// instantiate</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ctl = <span class="kwrd">new</span> Controller;</code><span class="hits">1</span></li><li class="covered"><code>    ctl.<span class="func">reset</span>();</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">// and run through configurator code</span></code></li><li class="covered"><code>    ctl.<span class="func">build</span>(code, railway.rootModule);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (!railway.app.settings.quiet) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">var</span> logger = ctl.<span class="func">getLogger</span>();</code><span class="hits">1</span></li><li class=""><code>        logger.<span class="func">on</span>(<span class="S">'beforeProcessing'</span>, <span class="kwrd">function</span> (ctl) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">var</span> req = ctl.context.req;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>            <span class="func">log</span>(</code></li><li class=""><code>                <span class="S">'\n'</span> + <span class="func">$</span>((<span class="kwrd">new</span> Date).<span class="func">toString</span>()).yellow + <span class="S">' '</span> + <span class="func">$</span>(ctl.id <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>).bold +</code></li><li class=""><code>                <span class="S">'\n'</span> +</code></li><li class=""><code>                <span class="func">$</span>(req.method).bold + <span class="S">' '</span> + <span class="func">$</span>(req.url).grey +</code></li><li class=""><code>                <span class="S">' controller: '</span> + <span class="func">$</span>(ctl.controllerName).cyan +</code></li><li class=""><code>                <span class="S">' action: '</span> + <span class="func">$</span>(ctl.actionName).blue</code></li><li class="covered"><code>            );</code><span class="hits">1</span></li><li class=""><code>            <span class="kwrd">if</span> (req.query &amp;&amp; Object.<span class="func">keys</span>(req.query).length) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">log</span>(<span class="func">$</span>(<span class="S">'Query: '</span>).bold + JSON.<span class="func">stringify</span>(req.query));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>            <span class="kwrd">if</span> (req.body &amp;&amp; req.method !== <span class="S">'GET'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> filteredBody = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>                Object.<span class="func">keys</span>(req.body).<span class="func">forEach</span>(<span class="kwrd">function</span> (param) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (!(ctl.constructor.filterParams <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>).<span class="func">some</span>(<span class="kwrd">function</span> (filter) <span class="gly">{</span><span class="kwrd">return</span> param.<span class="func">search</span>(filter) !== -1;<span class="gly">}</span>)) <span class="gly">{</span></code></li><li class="uncovered"><code>                        filteredBody<span class="gly">[</span>param<span class="gly">]</span> = req.body<span class="gly">[</span>param<span class="gly">]</span>;</code></li><li class=""><code>                    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                        filteredBody<span class="gly">[</span>param<span class="gly">]</span> = <span class="S">'[FILTERED]'</span>;</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="gly">}</span>);</code></li><li class="uncovered"><code>                <span class="func">log</span>(<span class="func">$</span>(<span class="S">'Body:  '</span>).bold + JSON.<span class="func">stringify</span>(filteredBody));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>        logger.<span class="func">on</span>(<span class="S">'afterProcessing'</span>, <span class="kwrd">function</span> (ctl, duration) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> req = ctl.context.req;</code></li><li class=""><code>            <span class="func">log</span>(<span class="S">'Handling '</span> + <span class="func">$</span>(req.method).bold + <span class="S">' '</span> + <span class="func">$</span>(req.url).grey +</code></li><li class="uncovered"><code>            <span class="S">' completed in '</span> + duration + <span class="S">' ms'</span>);</code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>        logger.<span class="func">on</span>(<span class="S">'beforeHook'</span>, <span class="kwrd">function</span> (ctl, action) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (ctl.context.inAction) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">log</span>(<span class="S">'&gt;&gt;&gt; perform '</span> + <span class="func">$</span>(action).bold.cyan);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>                <span class="func">log</span>(<span class="S">'&gt;&gt;&gt; perform '</span> + <span class="func">$</span>(action).bold.grey);</code><span class="hits">2</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>        logger.<span class="func">on</span>(<span class="S">'afterHook'</span>, <span class="kwrd">function</span> (ctl, action, duration) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="func">log</span>(<span class="S">'&lt;&lt;&lt; '</span> + action + <span class="S">' ['</span> + duration + <span class="S">' ms]'</span>);</code><span class="hits">2</span></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> ctl;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-controller-extensions-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-controller-extensions-js" class="filename trigger" name="lib-controller-extensions-js">lib/controller-extensions.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 10%"><strong>10%</strong> [7/68]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code></code></li><li class=""><code><span class="kwrd">var</span> utils       = <span class="func">require</span>(<span class="S">'./railway_utils'</span>),</code></li><li class=""><code>    fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    path = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    safeMerge  = utils.safe_merge,</code></li><li class=""><code>    $           = utils.stylize.$,</code></li><li class="covered"><code>    log         = utils.debug;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">Controller</span>() <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Render response.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} view name [optional]</span></code></li><li class=""><code><span class="C"> * @param {Object} locals - data passed to view as local variables [optional]</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * When first parameter is omitted action name used as view name:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action(function index() {</span></code></li><li class=""><code><span class="C"> *     render(); ~~~C0~~~</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Second argument is optional too, you can set local variables using `this` inside</span></code></li><li class=""><code><span class="C"> * action:</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action('new', function () {</span></code></li><li class=""><code><span class="C"> *     this.title = 'Create new post';</span></code></li><li class=""><code><span class="C"> *     this.post = new Post;</span></code></li><li class=""><code><span class="C"> *     render();</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * will result the same as</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> * action('new', function () {</span></code></li><li class=""><code><span class="C"> *     render({</span></code></li><li class=""><code><span class="C"> *         title: 'Create new post',</span></code></li><li class=""><code><span class="C"> *         post: new Post</span></code></li><li class=""><code><span class="C"> *     });</span></code></li><li class=""><code><span class="C"> * });</span></code></li><li class=""><code><span class="C"> * ```</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.<span class="kwrd">prototype</span>.render = <span class="kwrd">function</span> (arg1, arg2) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> railway = this.railway;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> app = railway.app;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> views = railway.structure.views;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> res = this.res;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> self = this;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> view, params;</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> arg1 == <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        view = arg1;</code></li><li class="uncovered"><code>        params = arg2;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        view = this.actionName;</code></li><li class="uncovered"><code>        params = arg1;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    params = params <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>    params.request = this.req;</code></li><li class="uncovered"><code>    params.params = this.params;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">var</span> layout = this.<span class="func">layout</span>(),</code></li><li class="uncovered"><code>        file = this.controllerName + <span class="S">'/'</span> + view;</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> helper = railway.structure.helpers<span class="gly">[</span>this.controllerName + <span class="S">'_helper'</span><span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="kwrd">var</span> appHelper = railway.structure.helpers.application_helper;</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="func">log</span>(<span class="S">'Rendering'</span>, <span class="func">$</span>(file).grey, <span class="S">'using layout'</span>, <span class="func">$</span>(layout).grey);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> helpers = railway.helpers.<span class="func">personalize</span>(this);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> locals = <span class="func">safeMerge</span>(params, this.locals, helpers, helpers.__proto__, helper, appHelper);</code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="func">ensureFlash</span>(this.req);</code></li><li class=""><code></code></li><li class="uncovered"><code>    res.renderCalled = true;</code></li><li class=""><code></code></li><li class="uncovered"><code>    layout = layout ? <span class="S">'layouts/'</span> + layout : false;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (layout) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> html = <span class="func">render</span>(file, locals, false);</code></li><li class=""><code>        <span class="kwrd">if</span> (html) <span class="gly">{</span></code></li><li class="uncovered"><code>            locals.body = html;</code></li><li class="uncovered"><code>            <span class="func">render</span>(layout, locals, true);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="func">render</span>(file, locals, true);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">render</span>(file, params, send) <span class="gly">{</span></code></li><li class="uncovered"><code>        params = <span class="func">declarePartial</span>(file, params);</code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> html = views<span class="gly">[</span>file<span class="gly">]</span>(params);</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            self.<span class="func">next</span>(e);</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> false;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (send) <span class="gly">{</span></code></li><li class="uncovered"><code>            res.<span class="func">send</span>(html);</code></li><li class=""><code>            <span class="kwrd">if</span> (self.context.inAction) <span class="gly">{</span></code></li><li class="uncovered"><code>                self.<span class="func">next</span>();</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> html;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">declarePartial</span>(parentFile, p) <span class="gly">{</span></code></li><li class="uncovered"><code>        p = p <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> parentDir = path.<span class="func">dirname</span>(parentFile);</code></li><li class=""><code>        p.partial = <span class="kwrd">function</span> (file, params) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">if</span> (file.<span class="func">indexOf</span>(<span class="S">'.ejs'</span>)) file = file.<span class="func">replace</span>(<span class="S">'.ejs'</span>, <span class="S">''</span>);</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> dir = path.<span class="func">dirname</span>(file);</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> base = path.<span class="func">basename</span>(file);</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> found;</code></li><li class=""><code>            <span class="kwrd">var</span> fn = views<span class="gly">[</span>found = file<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span></code></li><li class=""><code>                views<span class="gly">[</span>found = parentDir + <span class="S">'/'</span> + file<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span></code></li><li class=""><code>                views<span class="gly">[</span>found = parentDir + <span class="S">'/_'</span> + file<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span></code></li><li class="uncovered"><code>                views<span class="gly">[</span>found = dir + <span class="S">'/_'</span> + base<span class="gly">]</span>;</code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">if</span> (!fn) <span class="gly">{</span></code></li><li class=""><code>                throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="gly">[</span></code></li><li class=""><code>                    <span class="S">'Partial lookup failed. Tried:'</span>,</code></li><li class=""><code>                    <span class="S">' - '</span> + file,</code></li><li class=""><code>                    <span class="S">' - '</span> + parentDir + <span class="S">'/'</span> + file,</code></li><li class=""><code>                    <span class="S">' - '</span> + parentDir + <span class="S">'/_'</span> + file,</code></li><li class=""><code>                    <span class="S">' - '</span> + dir + <span class="S">'/_'</span> + base,</code></li><li class="uncovered"><code>                <span class="gly">]</span>.jo<span class="kwrd">in</span>(<span class="S">'\n'</span>));</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> context = <span class="func">declarePartial</span>(found, params);</code></li><li class=""><code></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> <span class="func">fn</span>(<span class="func">safeMerge</span>(context, context.locals, p));</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> p;</code></li><li class=""><code></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">ensureFlash</span>(req) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (req.flash) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    req.flash = <span class="kwrd">function</span> <span class="func">_flash</span>(type, msg) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (this.session === undefined) throw <span class="func">Error</span>(<span class="S">'req.flash() requires sessions'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> msgs = this.session.flash = this.session.flash <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (type &amp;&amp; msg) <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// util.format is available in Node.js 0.6+</span></code></li><li class=""><code>            <span class="C">// if (arguments.length &gt; 2 &amp;&amp; format) {</span></code></li><li class=""><code>                <span class="C">// var args = Array.prototype.slice.call(arguments, 1);</span></code></li><li class=""><code>                <span class="C">// msg = format.apply(undefined, args);</span></code></li><li class=""><code>            <span class="C">// }</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> (msgs<span class="gly">[</span>type<span class="gly">]</span> = msgs<span class="gly">[</span>type<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>).<span class="func">push</span>(msg);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="kwrd">if</span> (type) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> arr = msgs<span class="gly">[</span>type<span class="gly">]</span>;</code></li><li class="uncovered"><code>            delete msgs<span class="gly">[</span>type<span class="gly">]</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> arr <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>            this.session.flash = <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>            <span class="kwrd">return</span> msgs;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Layout setter/getter</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - when called without arguments, used as getter,</span></code></li><li class=""><code><span class="C"> * - when called with string, used as setter</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * When `layout` not called controller trying to get guess which layout to use.</span></code></li><li class=""><code><span class="C"> * First of all controller looking for layout with the same name as controller,</span></code></li><li class=""><code><span class="C"> * for example `users_controller` will choose `users_laout`, if there's no </span></code></li><li class=""><code><span class="C"> * layout with this name, controller using `application_layout`.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * If you do not want to use any layout by default, you can just set it up:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *     app.set('view options', {layout: false});</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * this will prevent you from repeating `layout(false)` in each controller where</span></code></li><li class=""><code><span class="C"> * you do not want to use layout, for example in api controllers.</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * - choose </span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} layout - [optional] layout name</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>Controller.<span class="kwrd">prototype</span>.layout = <span class="kwrd">function</span> <span class="func">layout</span>(l) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">var</span> railway = this.railway;</code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> l !== <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.constructor.layout = l;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (<span class="kwrd">typeof</span> this.constructor.layout === <span class="S">'undefined'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        this.constructor.layout = railway.structure.views.<span class="func">hasOwnProperty</span>(<span class="S">'layouts/'</span> + this.controllerName + <span class="S">'_layout'</span>) ? this.controllerName : <span class="S">'application'</span>;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this.constructor.layout ? this.constructor.layout + <span class="S">'_layout'</span> : null;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Controller.<span class="kwrd">prototype</span>.load = <span class="kwrd">function</span> (controllerName) <span class="gly">{</span></code></li><li class="covered"><code>    this.<span class="func">build</span>(this.railway.structure.controllers<span class="gly">[</span>controllerName + <span class="S">'_controller'</span><span class="gly">]</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>Controller.<span class="kwrd">prototype</span>.t = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!this._t) <span class="gly">{</span></code></li><li class="uncovered"><code>        this._t = this.railway.<span class="func">T</span>();</code></li><li class="uncovered"><code>        this._t.locale = this.app.settings.defaultLocale <span class="gly">|</span><span class="gly">|</span> <span class="S">'en'</span>;</code></li><li class="uncovered"><code>        this._T = this.railway.T;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="kwrd">return</span> this._t.<span class="func">apply</span>(this, <span class="gly">[</span><span class="gly">]</span>.slice.<span class="func">call</span>(arguments));</code></li><li class=""><code></code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>module.exports = Controller.<span class="kwrd">prototype</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-railway-utils-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-railway-utils-js" class="filename trigger" name="lib-railway-utils-js">lib/railway_utils.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 93%"><strong>93%</strong> [52/56]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> undef, sys = <span class="func">require</span>(<span class="S">'util'</span>),</code></li><li class=""><code>    path = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    Module = <span class="func">require</span>(<span class="S">'module'</span>),</code></li><li class=""><code>    vm = <span class="func">require</span>(<span class="S">'vm'</span>),</code></li><li class="covered"><code>    yaml = <span class="func">require</span>(<span class="S">'yaml-js'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.html_tag_params = <span class="kwrd">function</span> (params, override) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> maybe_params = <span class="S">''</span>;</code><span class="hits">16</span></li><li class="covered"><code>    <span class="func">safe_merge</span>(params, override);</code><span class="hits">16</span></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> params) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (params<span class="gly">[</span>key<span class="gly">]</span> != undef) <span class="gly">{</span></code></li><li class="covered"><code>            maybe_params += <span class="S">' '</span> + key + <span class="S">'="'</span> + params<span class="gly">[</span>key<span class="gly">]</span>.<span class="func">toString</span>().<span class="func">replace</span>(/&amp;/g, <span class="S">'&amp;amp;'</span>).<span class="func">replace</span>(/<span class="S">"/g, '&amp;quot;') + '"</span>';</code><span class="hits">41</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> maybe_params;</code><span class="hits">16</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> safe_merge = exports.safe_merge = <span class="kwrd">function</span> (merge_what) <span class="gly">{</span></code></li><li class="covered"><code>    merge_what = merge_what <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">16</span></li><li class=""><code>    Array.<span class="kwrd">prototype</span>.slice.<span class="func">call</span>(arguments).<span class="func">forEach</span>(<span class="kwrd">function</span> (merge_with, i) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">if</span> (i == 0) <span class="kwrd">return</span>;</code><span class="hits">16</span></li><li class=""><code>        <span class="kwrd">for</span> (<span class="kwrd">var</span> key <span class="kwrd">in</span> merge_with) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">if</span> (!merge_with.<span class="func">hasOwnProperty</span>(key) <span class="gly">|</span><span class="gly">|</span> key <span class="kwrd">in</span> merge_what) <span class="kwrd">continue</span>;</code><span class="hits">10</span></li><li class="covered"><code>            merge_what<span class="gly">[</span>key<span class="gly">]</span> = merge_with<span class="gly">[</span>key<span class="gly">]</span>;</code><span class="hits">10</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">16</span></li><li class="covered"><code>    <span class="kwrd">return</span> merge_what;</code><span class="hits">16</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.humanize = <span class="kwrd">function</span> (underscored) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> res = underscored.<span class="func">replace</span>(/_/g, <span class="S">' '</span>);</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">return</span> res<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + res.<span class="func">substr</span>(1);</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.camelize = <span class="kwrd">function</span> (underscored, upcaseFirstLetter) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> res = <span class="S">''</span>;</code><span class="hits">5</span></li><li class=""><code>    underscored.<span class="func">split</span>(<span class="S">'_'</span>).<span class="func">forEach</span>(<span class="kwrd">function</span> (part) <span class="gly">{</span></code></li><li class="covered"><code>        res += part<span class="gly">[</span>0<span class="gly">]</span>.toUpper<span class="kwrd">Case</span>() + part.<span class="func">substr</span>(1);</code><span class="hits">8</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">5</span></li><li class="covered"><code>    <span class="kwrd">return</span> upcaseFirstLetter ? res : res<span class="gly">[</span>0<span class="gly">]</span>.toLower<span class="kwrd">Case</span>() + res.<span class="func">substr</span>(1);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.classify = <span class="kwrd">function</span> (str) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> exports.<span class="func">camelize</span>(exports.<span class="func">singularize</span>(str));</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.underscore = <span class="kwrd">function</span> (camelCaseStr) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> initialUnderscore = camelCaseStr.<span class="func">match</span>(/^_/) ? <span class="S">'_'</span> : <span class="S">''</span>;</code><span class="hits">4</span></li><li class=""><code>    <span class="kwrd">var</span> str = camelCaseStr</code></li><li class=""><code>        .<span class="func">replace</span>(/^<span class="func">_</span>(<span class="gly">[</span>A-Z<span class="gly">]</span>)/g, <span class="S">'$1'</span>)</code></li><li class=""><code>        .<span class="func">replace</span>(/(<span class="gly">[</span>A-Z<span class="gly">]</span>)/g, <span class="S">'_$1'</span>)</code></li><li class="covered"><code>        .<span class="func">replace</span>(/^_/, initialUnderscore);</code><span class="hits">4</span></li><li class="covered"><code>    <span class="kwrd">return</span> str.toLower<span class="kwrd">Case</span>(); </code><span class="hits">4</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.singularize = <span class="func">require</span>(<span class="S">'../vendor/inflection.js'</span>).singularize;</code><span class="hits">1</span></li><li class="covered"><code>exports.pluralize   = <span class="func">require</span>(<span class="S">'../vendor/inflection.js'</span>).pluralize;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// Stylize a string</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">stylize</span>(str, style) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">var</span> styles = <span class="gly">{</span></code></li><li class=""><code>        <span class="S">'bold'</span>      : <span class="gly">[</span>1,  22<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'italic'</span>    : <span class="gly">[</span>3,  23<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'underline'</span> : <span class="gly">[</span>4,  24<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'cyan'</span>      : <span class="gly">[</span>96, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'blue'</span>      : <span class="gly">[</span>34, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'yellow'</span>    : <span class="gly">[</span>33, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'green'</span>     : <span class="gly">[</span>32, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'red'</span>       : <span class="gly">[</span>31, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'grey'</span>      : <span class="gly">[</span>90, 39<span class="gly">]</span>,</code></li><li class=""><code>        <span class="S">'green-hi'</span>  : <span class="gly">[</span>92, 32<span class="gly">]</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">187</span></li><li class="covered"><code>    <span class="kwrd">var</span> s = styles<span class="gly">[</span>style<span class="gly">]</span>;</code><span class="hits">187</span></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="S">'\033['</span> + s<span class="gly">[</span>0<span class="gly">]</span> + <span class="S">'m'</span> + str + <span class="S">'\033['</span> + s<span class="gly">[</span>1<span class="gly">]</span> + <span class="S">'m'</span>;</code><span class="hits">187</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> $ = <span class="kwrd">function</span> (str) <span class="gly">{</span></code></li><li class="covered"><code>    str = <span class="kwrd">new</span>(String)(str);</code><span class="hits">291</span></li><li class=""><code></code></li><li class=""><code>    <span class="gly">[</span><span class="S">'bold'</span>, <span class="S">'grey'</span>, <span class="S">'yellow'</span>, <span class="S">'red'</span>, <span class="S">'green'</span>, <span class="S">'cyan'</span>, <span class="S">'blue'</span>, <span class="S">'italic'</span>, <span class="S">'underline'</span><span class="gly">]</span>.<span class="func">forEach</span>(<span class="kwrd">function</span> (style) <span class="gly">{</span></code></li><li class=""><code>        Object.<span class="func">defineProperty</span>(str, style, <span class="gly">{</span></code></li><li class=""><code>            get: <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>                <span class="kwrd">return</span> <span class="func">$</span>(<span class="func">stylize</span>(this, style));</code><span class="hits">187</span></li><li class=""><code>            <span class="gly">}</span></code></li><li class="covered"><code>        <span class="gly">}</span>);</code><span class="hits">2619</span></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">291</span></li><li class="covered"><code>    <span class="kwrd">return</span> str;</code><span class="hits">291</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>stylize.$ = $;</code><span class="hits">1</span></li><li class="covered"><code>exports.stylize = stylize;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">var</span> addCoverage = exports.addCoverage = <span class="kwrd">function</span> (code, filename) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (!global.__cov) <span class="kwrd">return</span> code;</code></li><li class="uncovered"><code>    <span class="kwrd">return</span> <span class="func">require</span>(<span class="S">'semicov'</span>).<span class="func">addCoverage</span>(code, filename);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">// cache for source code</span></code></li><li class="covered"><code><span class="kwrd">var</span> cache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code><span class="C">// cache for compiled scripts</span></code></li><li class="covered"><code><span class="kwrd">var</span> scriptCache = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addSpaces</span>(str, len, to_start) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> str_len = str.length;</code><span class="hits">2</span></li><li class=""><code>    <span class="kwrd">for</span> (<span class="kwrd">var</span> i = str_len; i &lt; len; i += 1) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (!to_start) <span class="gly">{</span></code></li><li class="covered"><code>            str += <span class="S">' '</span>;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="covered"><code>            str = <span class="S">' '</span> + str;</code><span class="hits">3</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> str;</code><span class="hits">2</span></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.addSpaces = addSpaces;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">readYaml</span>(file) <span class="gly">{</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(file).<span class="func">shift</span>();</code></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>        console.<span class="func">log</span>(<span class="S">'Error in reading'</span>, file);</code></li><li class="uncovered"><code>        console.<span class="func">log</span>(e.message);</code></li><li class="uncovered"><code>        console.<span class="func">log</span>(e.stack);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code><span class="gly">}</span></code></li><li class="covered"><code>exports.readYaml = readYaml;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.existsSync = fs.existsSync <span class="gly">|</span><span class="gly">|</span> path.existsSync;</code><span class="hits">1</span></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-locales-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-locales-js" class="filename trigger" name="lib-locales-js">lib/locales.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 16%"><strong>16%</strong> [8/50]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    yaml = <span class="func">require</span>(<span class="S">'yaml-js'</span>),</code></li><li class=""><code>    coffee = <span class="func">require</span>(<span class="S">'coffee-script'</span>),</code></li><li class=""><code>    path = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class="covered"><code>    localeData = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>module.exports = <span class="kwrd">function</span> (rw) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> app = rw.app;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="C">/**</span></code></li><li class=""><code><span class="C">     * Initialize localization module</span></code></li><li class=""><code><span class="C">     */</span></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> <span class="func">init</span>() <span class="gly">{</span></code><span class="hits">1</span></li><li class="covered"><code>        <span class="kwrd">var</span> dir = rw.root + <span class="S">'/config/locales'</span>;</code><span class="hits">1</span></li><li class=""><code>        <span class="kwrd">if</span> (!rw.utils.<span class="func">existsSync</span>(dir)) <span class="gly">{</span></code></li><li class="covered"><code>            <span class="kwrd">return</span> false;</code><span class="hits">1</span></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        rw.locales = rw.locales <span class="gly">|</span><span class="gly">|</span> <span class="gly">[</span><span class="gly">]</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="func">load</span>(dir, rw);</code></li><li class=""><code></code></li><li class="uncovered"><code>        rw.t = <span class="func">T</span>(true);</code></li><li class="uncovered"><code>        rw.T = T;</code></li><li class=""><code></code></li><li class=""><code>        <span class="C">/**</span></code></li><li class=""><code><span class="C">         * Global translation helper</span></code></li><li class=""><code><span class="C">         *</span></code></li><li class=""><code><span class="C">         * @param {Boolean} global</span></code></li><li class=""><code><span class="C">         * @public</span></code></li><li class=""><code><span class="C">         */</span></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">T</span>(global) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (global) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// helper for global scope (models, initializers, etc)</span></code></li><li class=""><code>                <span class="C">// requires two params (locale expected)</span></code></li><li class=""><code>                <span class="kwrd">return</span> <span class="kwrd">function</span> <span class="func">t</span>(path, locale, defaultValue) <span class="gly">{</span></code></li><li class=""><code>                    <span class="kwrd">if</span> (!locale) <span class="gly">{</span></code></li><li class="uncovered"><code>                        throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Locale expected'</span>);</code></li><li class=""><code>                    <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="func">translate</span>(path, locale);</code></li><li class="uncovered"><code>                <span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// helper for local scope (controllers, views, helpers)</span></code></li><li class=""><code>                <span class="C">// requires one param</span></code></li><li class=""><code>                <span class="kwrd">return</span> <span class="kwrd">function</span> <span class="func">t</span>(path, defaultValue) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="func">translate</span>(path, t.locale, defaultValue);</code></li><li class="uncovered"><code>                <span class="gly">}</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">function</span> <span class="func">translate</span>(path, locale, defaultValue) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> translation = localeData<span class="gly">[</span>locale<span class="gly">]</span>, substitute;</code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">function</span> <span class="func">nextPathItem</span>(token) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> (translation = translation<span class="gly">[</span>token<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (<span class="kwrd">typeof</span> path === <span class="S">'string'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                    substitute = false;</code></li><li class=""><code>                <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                    substitute = path;</code></li><li class="uncovered"><code>                    path = substitute.<span class="func">shift</span>();</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (!translation <span class="gly">|</span><span class="gly">|</span> !path.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">every</span>(nextPathItem)) <span class="gly">{</span></code></li><li class="uncovered"><code>                    translation = defaultValue <span class="gly">|</span><span class="gly">|</span> <span class="func">translationMissing</span>(locale, path);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (translation &amp;&amp; substitute &amp;&amp; substitute.length) <span class="gly">{</span></code></li><li class=""><code>                    substitute.<span class="func">forEach</span>(<span class="kwrd">function</span> (substitution) <span class="gly">{</span></code></li><li class="uncovered"><code>                        translation = translation.<span class="func">replace</span>(/%/, substitution.<span class="func">toString</span>().<span class="func">replace</span>(/%/g, <span class="S">''</span>));</code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span> translation;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>            <span class="kwrd">function</span> <span class="func">translationMissing</span>(locale, path) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">switch</span> (app.settings.translationMissing) <span class="gly">{</span></code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'display'</span>:</code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> <span class="S">'translation missing for '</span> + locale + <span class="S">'.'</span> + path;</code></li><li class=""><code>                <span class="kwrd">case</span> <span class="S">'default'</span>:</code></li><li class=""><code>                <span class="kwrd">case</span> undefined:</code></li><li class="uncovered"><code>                    <span class="kwrd">var</span> defLocale = app.settings.defaultLocale;</code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> !defLocale <span class="gly">|</span><span class="gly">|</span> locale === defLocale ? <span class="S">''</span> : <span class="func">translate</span>(path, defLocale);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>        T.localeSupported = <span class="kwrd">function</span> (localeName) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">return</span> !!localeData<span class="gly">[</span>localeName<span class="gly">]</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>;</code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Load localization files from `dir`. Locales can be in yaml, json or coffee</span></code></li><li class=""><code><span class="C"> * format</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * Example locale.yml file:</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> *    en:</span></code></li><li class=""><code><span class="C"> *      key: 'Value'</span></code></li><li class=""><code><span class="C"> *</span></code></li><li class=""><code><span class="C"> * @param {String} dir - absolute path to locales directory</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">load</span>(dir, rw) <span class="gly">{</span></code></li><li class=""><code>    fs.<span class="func">readdirSync</span>(dir).<span class="func">forEach</span>(<span class="kwrd">function</span> (file) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (file.<span class="func">match</span>(/^\./)) <span class="kwrd">return</span>;</code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> filename = dir + <span class="S">'/'</span> + file;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> code = fs.<span class="func">readFileSync</span>(filename, <span class="S">'utf8'</span>).<span class="func">toString</span>();</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> obj;</code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (file.<span class="func">match</span>(/\.ya?ml$/)) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = <span class="func">require</span>(filename).<span class="func">shift</span>();</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (file.<span class="func">match</span>(/\.json/)) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = JSON.<span class="func">parse</span>(code);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="kwrd">if</span> (file.<span class="func">match</span>(/\.coffee/)) <span class="gly">{</span></code></li><li class="uncovered"><code>                obj = coffee.<span class="func">eval</span>(code);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                console.<span class="func">log</span>(<span class="S">'Unsupported extension of locale file '</span> + filename);</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            console.<span class="func">log</span>(<span class="S">'Parsing file '</span> + filename);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(e);</code></li><li class="uncovered"><code>            console.<span class="func">log</span>(e.stack);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (obj) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">addTranslation</span>(obj, rw);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Add translation to `lang` to application locales collection</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">addTranslation</span>(lang, rw) <span class="gly">{</span></code></li><li class=""><code>    Object.<span class="func">keys</span>(lang).<span class="func">forEach</span>(<span class="kwrd">function</span> (localeName) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> translations = lang<span class="gly">[</span>localeName<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (rw.locales.<span class="func">indexOf</span>(localeName) === -1) <span class="gly">{</span></code></li><li class="uncovered"><code>            rw.locales.<span class="func">push</span>(<span class="gly">[</span>localeName, translations.lang &amp;&amp; translations.lang.name <span class="gly">|</span><span class="gly">|</span> localeName<span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        localeData<span class="gly">[</span>localeName<span class="gly">]</span> = localeData<span class="gly">[</span>localeName<span class="gly">]</span> <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class=""><code>        Object.<span class="func">keys</span>(translations).<span class="func">forEach</span>(<span class="kwrd">function</span> (namespace) <span class="gly">{</span></code></li><li class="uncovered"><code>            localeData<span class="gly">[</span>localeName<span class="gly">]</span><span class="gly">[</span>namespace<span class="gly">]</span> = translations<span class="gly">[</span>namespace<span class="gly">]</span>;</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-extensions-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-extensions-js" class="filename trigger" name="lib-extensions-js">lib/extensions.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 48%"><strong>48%</strong> [14/29]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> utils = <span class="func">require</span>(<span class="S">'./railway_utils'</span>),</code></li><li class=""><code>    fs = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    cs = <span class="func">require</span>(<span class="S">'coffee-script'</span>),</code></li><li class="covered"><code>    path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>module.exports = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>    this.extensions = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class="covered"><code>    <span class="kwrd">var</span> ctx = <span class="func">getNPMFileContext</span>(this);</code><span class="hits">1</span></li><li class=""><code>    <span class="kwrd">var</span> js = <span class="S">'npmfile.js'</span>, coffee = <span class="S">'npmfile.coffee'</span>,</code></li><li class="covered"><code>        filename;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(path.jo<span class="kwrd">in</span>(root, js))) <span class="gly">{</span></code></li><li class="uncovered"><code>        filename = js;</code></li><li class=""><code>    <span class="gly">}</span> else <span class="kwrd">if</span> (utils.<span class="func">existsSync</span>(path.jo<span class="kwrd">in</span>(root, coffee))) <span class="gly">{</span></code></li><li class="uncovered"><code>        filename = coffee;</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code>    <span class="kwrd">if</span> (filename) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> code = fs.<span class="func">readFileSync</span>(filename).<span class="func">toString</span>();</code></li><li class=""><code>        <span class="kwrd">if</span> (filename.<span class="func">match</span>(/\.coffee/)) <span class="gly">{</span></code></li><li class="uncovered"><code>            code = cs.<span class="func">compile</span>(code);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> fn = <span class="kwrd">new</span> <span class="kwrd">Function</span>(<span class="S">'require'</span>, <span class="S">'group'</span>, <span class="S">'__dirname'</span>, <span class="S">'__filename'</span>, code);</code></li><li class="uncovered"><code>        fn.<span class="func">call</span>(null, ctx.require, ctx.group, path.<span class="func">dirname</span>(filename), filename);</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="func">initBundledExtensions</span>(this);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize extensions (using npmfile)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Prepare context for executing npm file. Context has two additional features:</span></code></li><li class=""><code><span class="C"> * - group</span></code></li><li class=""><code><span class="C"> * - improved require (run init method of module)</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">getNPMFileContext</span>(rw) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> ctx = <span class="gly">{</span><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    ctx.require = <span class="kwrd">function</span> (package) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ext = rw.extensions<span class="gly">[</span>package<span class="gly">]</span> = <span class="func">require</span>(package);</code></li><li class=""><code>        <span class="kwrd">if</span> (ext &amp;&amp; ext.init) <span class="gly">{</span></code></li><li class="uncovered"><code>            ext.<span class="func">init</span>(rw);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    ctx.group = <span class="kwrd">function</span> (env, callback) <span class="gly">{</span></code></li><li class=""><code>        <span class="kwrd">if</span> (env == rw.app.settings.env) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">callback</span>();</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> ctx;</code><span class="hits">1</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">initBundledExtensions</span>(rw) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="func">envInfo</span>(rw);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Setup route /railway/environment.json to return information about environment</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">envInfo</span>(rw) <span class="gly">{</span></code></li><li class="covered"><code>    <span class="kwrd">var</span> jugglingdbVersion, npmVersion;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    rw.app.<span class="func">all</span>(<span class="S">'/railway/environment.json'</span>, <span class="kwrd">function</span> (req, res) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> jugglingdbVersion = <span class="func">require</span>(<span class="S">'jugglingdb'</span>).version;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> npmVersion = <span class="func">require</span>(<span class="S">'npm'</span>).version;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>        try <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> viewEngineVersion = <span class="func">require</span>(rw.app.root + <span class="S">'/node_modules/'</span> +  rw.app.<span class="func">set</span>(<span class="S">'view engine'</span>)).version;</code></li><li class=""><code>        <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span></code></li><li class="uncovered"><code>            viewEngineVersion = <span class="S">'not installed'</span>;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (rw.app.<span class="func">disabled</span>(<span class="S">'env info'</span>)) <span class="kwrd">return</span> res.<span class="func">send</span>(<span class="gly">{</span>forbidden: true<span class="gly">}</span>);</code></li><li class=""><code>        res.<span class="func">send</span>(<span class="gly">{</span></code></li><li class=""><code>            settings: rw.app.settings,</code></li><li class=""><code>            versions: <span class="gly">{</span></code></li><li class=""><code>                core: process.versions,</code></li><li class=""><code>                npm: npmVersion,</code></li><li class=""><code>                railway: rw.version,</code></li><li class=""><code>                jugglingdb: jugglingdbVersion,</code></li><li class=""><code>                templating: <span class="gly">{</span></code></li><li class=""><code>                    name: rw.app.<span class="func">set</span>(<span class="S">'view engine'</span>),</code></li><li class=""><code>                    version: viewEngineVersion</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            application: <span class="gly">{</span></code></li><li class=""><code>                root: rw.app.root,</code></li><li class=""><code>                database: <span class="func">require</span>(rw.app.root + <span class="S">'/config/database'</span>)<span class="gly">[</span>rw.app.<span class="func">set</span>(<span class="S">'env'</span>)<span class="gly">]</span>.driver,</code></li><li class=""><code>                middleware: rw.app.stack.<span class="func">map</span>(<span class="kwrd">function</span> (m) <span class="gly">{</span></code></li><li class="uncovered"><code>                    <span class="kwrd">return</span> m.handle.name;</code></li><li class=""><code>                <span class="gly">}</span>)</code></li><li class=""><code>            <span class="gly">}</span>,</code></li><li class=""><code>            env: process.env,</code></li><li class="uncovered"><code>        <span class="gly">}</span>);</code></li><li class="covered"><code>    <span class="gly">}</span>);</code><span class="hits">1</span></li><li class=""><code><span class="gly">}</span></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-structure-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-structure-js" class="filename trigger" name="lib-structure-js">lib/structure.js</a></div><div class="span6"><div class="progress progress-danger"> <div class="bar" style="width: 25%"><strong>25%</strong> [7/28]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> Module = <span class="func">require</span>(<span class="S">'module'</span>).Module;</code><span class="hits">1</span></li><li class="covered"><code><span class="kwrd">var</span> cs = <span class="func">require</span>(<span class="S">'coffee-script'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>module.exports = <span class="kwrd">function</span> (rw) <span class="gly">{</span></code></li><li class=""><code></code></li><li class="covered"><code>    <span class="kwrd">return</span> <span class="kwrd">function</span> () <span class="gly">{</span></code><span class="hits">1</span></li><li class=""><code>        <span class="kwrd">return</span> <span class="gly">{</span></code></li><li class=""><code>            views: <span class="func">read</span>(<span class="S">'app/views'</span>, <span class="S">'view'</span>),</code></li><li class=""><code>            helpers: <span class="func">read</span>(<span class="S">'app/helpers'</span>, true),</code></li><li class=""><code>            controllers: <span class="func">read</span>(<span class="S">'app/controllers'</span>),</code></li><li class=""><code>            models: <span class="func">read</span>(<span class="S">'app/models'</span>, true)</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>;</code></li><li class=""><code></code></li><li class=""><code>    <span class="kwrd">function</span> <span class="func">read</span>(dir, doRequire, cts, prefix) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> contents = cts <span class="gly">|</span><span class="gly">|</span> <span class="gly">{</span><span class="gly">}</span>;</code></li><li class="uncovered"><code>        <span class="kwrd">var</span> abspath = rw.app.root + <span class="S">'/'</span> + dir;</code></li><li class="uncovered"><code>        prefix = prefix <span class="gly">|</span><span class="gly">|</span> <span class="S">''</span>;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">if</span> (fs.<span class="func">existsSync</span>(abspath)) <span class="gly">{</span></code></li><li class="uncovered"><code>            fs.<span class="func">readdirSync</span>(abspath).<span class="func">forEach</span>(readAndWatch);</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code></code></li><li class="uncovered"><code>        <span class="kwrd">return</span> contents;</code></li><li class=""><code></code></li><li class=""><code>        <span class="kwrd">function</span> <span class="func">readAndWatch</span>(filename) <span class="gly">{</span></code></li><li class=""><code>            <span class="kwrd">if</span> (filename.<span class="func">match</span>(/^\./)) <span class="gly">{</span></code></li><li class=""><code>                <span class="C">// skip files starting with point</span></code></li><li class="uncovered"><code>                <span class="kwrd">return</span>;</code></li><li class=""><code>            <span class="gly">}</span></code></li><li class="uncovered"><code>            <span class="kwrd">var</span> file = abspath + <span class="S">'/'</span> + filename;</code></li><li class="uncovered"><code>            <span class="kwrd">var</span> ext = filename.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">pop</span>();</code></li><li class=""><code>            <span class="kwrd">if</span> (fs.<span class="func">statSync</span>(file).<span class="func">isDirectory</span>()) <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="func">read</span>(dir + <span class="S">'/'</span> + filename, doRequire, contents, prefix + filename + <span class="S">'/'</span>);</code></li><li class=""><code>            <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                <span class="kwrd">var</span> name = prefix + filename.<span class="func">replace</span>(<span class="S">'.'</span> + ext, <span class="S">''</span>);</code></li><li class=""><code>                contents<span class="gly">[</span>name<span class="gly">]</span> =</code></li><li class=""><code>                    doRequire ?</code></li><li class=""><code>                    <span class="func">requireFile</span>(file, doRequire) :</code></li><li class="uncovered"><code>                    fs.<span class="func">readFileSync</span>(file).<span class="func">toString</span>();</code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (ext === <span class="S">'coffee'</span> &amp;&amp; !doRequire) <span class="gly">{</span></code></li><li class="uncovered"><code>                    contents<span class="gly">[</span>name<span class="gly">]</span> = cs.<span class="func">compile</span>(contents<span class="gly">[</span>name<span class="gly">]</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                <span class="kwrd">if</span> (rw.app.<span class="func">enabled</span>(<span class="S">'watch'</span>)) <span class="gly">{</span></code></li><li class=""><code></code></li><li class=""><code>                    fs.<span class="func">watch</span>(file, <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class=""><code>                        <span class="kwrd">if</span> (doRequire) <span class="gly">{</span></code></li><li class="uncovered"><code>                            delete Module._cache<span class="gly">[</span>file<span class="gly">]</span>;</code></li><li class="uncovered"><code>                            contents<span class="gly">[</span>name<span class="gly">]</span> = <span class="func">requireFile</span>(file, doRequire);</code></li><li class=""><code>                        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class="uncovered"><code>                            contents<span class="gly">[</span>name<span class="gly">]</span> = fs.<span class="func">readFileSync</span>(file).<span class="func">toString</span>();</code></li><li class=""><code></code></li><li class=""><code>                            <span class="kwrd">if</span> (ext === <span class="S">'coffee'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>                                contents<span class="gly">[</span>name<span class="gly">]</span> = cs.<span class="func">compile</span>(contents<span class="gly">[</span>name<span class="gly">]</span>);</code></li><li class=""><code>                            <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>                        <span class="gly">}</span></code></li><li class="uncovered"><code>                    <span class="gly">}</span>);</code></li><li class=""><code>                <span class="gly">}</span></code></li><li class=""><code>            <span class="gly">}</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">requireFile</span>(file, how) <span class="gly">{</span></code></li><li class="uncovered"><code>    <span class="kwrd">if</span> (how === true) <span class="kwrd">return</span> <span class="func">require</span>(file);</code></li><li class=""><code>    <span class="kwrd">if</span> (how === <span class="S">'view'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> ext = file.<span class="func">split</span>(<span class="S">'.'</span>).<span class="func">pop</span>();</code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (ext !== <span class="S">'ejs'</span> &amp;&amp; ext !== <span class="S">'jade'</span>) throw <span class="kwrd">new</span> <span class="func">Error</span>(<span class="S">'Only ejs and jade templates supported'</span>);</code></li><li class="uncovered"><code>        <span class="kwrd">return</span> <span class="func">require</span>(ext).<span class="func">compile</span>(fs.<span class="func">readFileSync</span>(file).<span class="func">toString</span>());</code></li><li class=""><code>    <span class="gly">}</span></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-models-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-models-js" class="filename trigger" name="lib-models-js">lib/models.js</a></div><div class="span6"><div class="progress progress-warning"> <div class="bar" style="width: 60%"><strong>60%</strong> [6/10]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="C">// Deps</span></code></li><li class=""><code><span class="kwrd">var</span> fs          = <span class="func">require</span>(<span class="S">'fs'</span>),</code></li><li class=""><code>    path        = <span class="func">require</span>(<span class="S">'path'</span>),</code></li><li class=""><code>    Module      = <span class="func">require</span>(<span class="S">'module'</span>),</code></li><li class="covered"><code>    utils       = <span class="func">require</span>(<span class="S">'./railway_utils'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="C">/**</span></code></li><li class=""><code><span class="C"> * Initialize models</span></code></li><li class=""><code><span class="C"> */</span></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> (rw) <span class="gly">{</span></code></li><li class=""><code>    <span class="C">// quietly fallback to default schema</span></code></li><li class=""><code>    try <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">if</span> (!rw.orm) <span class="func">require</span>(<span class="S">'jugglingdb'</span>).<span class="func">init</span>(rw);</code></li><li class=""><code>    <span class="gly">}</span> <span class="func">catch</span>(e) <span class="gly">{</span><span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    <span class="C">// then run models</span></code></li><li class="covered"><code>    <span class="func">loadModels</span>(rw);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code><span class="kwrd">function</span> <span class="func">loadModels</span>(rw) <span class="gly">{</span></code></li><li class=""><code>    <span class="kwrd">if</span> (!rw.structure.models) <span class="gly">{</span></code></li><li class="covered"><code>        <span class="kwrd">return</span>;</code><span class="hits">1</span></li><li class=""><code>    <span class="gly">}</span></code></li><li class=""><code></code></li><li class=""><code>    Object.<span class="func">keys</span>(rw.structure.models).<span class="func">forEach</span>(<span class="kwrd">function</span> (model) <span class="gly">{</span></code></li><li class="uncovered"><code>        <span class="kwrd">var</span> md = rw.structure.models<span class="gly">[</span>model<span class="gly">]</span>;</code></li><li class=""><code>        <span class="kwrd">if</span> (rw.models<span class="gly">[</span>model<span class="gly">]</span> &amp;&amp; rw.models<span class="gly">[</span>model<span class="gly">]</span>._validations) <span class="gly">{</span></code></li><li class="uncovered"><code>            delete rw.models<span class="gly">[</span>model<span class="gly">]</span>._validations;</code></li><li class=""><code>        <span class="gly">}</span></code></li><li class=""><code>        <span class="kwrd">if</span> (<span class="kwrd">typeof</span> md === <span class="S">'function'</span>) <span class="gly">{</span></code></li><li class="uncovered"><code>            <span class="func">md</span>(rw, rw.models<span class="gly">[</span>model<span class="gly">]</span>);</code></li><li class=""><code>        <span class="gly">}</span> else <span class="gly">{</span></code></li><li class=""><code>            <span class="C">// rw.models[md.name || md.modelName || model] = md;</span></code></li><li class=""><code>        <span class="gly">}</span></code></li><li class="uncovered"><code>    <span class="gly">}</span>);</code></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code></code></li></ol></pre></div></div>
<div id="lib-logger-js" class="file"><div class="row" style="margin-left: 30px;"><div class="span5"><a href="#lib-logger-js" class="filename trigger" name="lib-logger-js">lib/logger.js</a></div><div class="span6"><div class="progress progress-success"> <div class="bar" style="width: 100%"><strong>100%</strong> [9/9]</div></div></div></div><div class="file-contents"><pre><ol><li class="covered"><code><span class="kwrd">var</span> fs = <span class="func">require</span>(<span class="S">'fs'</span>);</code></li><li class="covered"><code><span class="kwrd">var</span> path = <span class="func">require</span>(<span class="S">'path'</span>);</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code>exports.stream = null;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.init = <span class="kwrd">function</span> (rw) <span class="gly">{</span></code></li><li class=""><code>    exports.stream = rw.app.settings.quiet ?</code></li><li class=""><code>        fs.<span class="func">createWriteStream</span>(path.jo<span class="kwrd">in</span>(app.root, <span class="S">'log'</span>, app.settings.env + <span class="S">'.log'</span>)) :</code></li><li class="covered"><code>        process.stdout;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>    rw.utils.debug = <span class="kwrd">function</span> () <span class="gly">{</span></code></li><li class="covered"><code>        rw.logger.<span class="func">write</span>(Array.<span class="kwrd">prototype</span>.jo<span class="kwrd">in</span>.<span class="func">call</span>(arguments, <span class="S">' '</span>));</code><span class="hits">5</span></li><li class="covered"><code>    <span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li><li class=""><code>exports.write = <span class="kwrd">function</span> (str) <span class="gly">{</span></code></li><li class="covered"><code>    (exports.stream <span class="gly">|</span><span class="gly">|</span> process.stdout).<span class="func">write</span>(str + <span class="S">'\n'</span>);</code><span class="hits">5</span></li><li class="covered"><code><span class="gly">}</span>;</code><span class="hits">1</span></li><li class=""><code></code></li></ol></pre></div></div>
        </div>
    </body>
    <script type="text/javascript" src="jquery.min.js"></script>
    <script type="text/javascript" src="bootstrap.js"></script>
    <script type="text/javascript" src="coverage.js"></script>
</html>

